<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Care Plan</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            position: relative;
        }
        .nav-tab:hover { background: #e9ecef; }
        .nav-tab.active { background: white; color: #667eea; }
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .home-container { text-align: center; padding: 60px 20px; }
        .home-container h2 { font-size: 2.5em; color: #333; margin-bottom: 20px; }
        .home-container p { font-size: 1.2em; color: #666; margin-bottom: 40px; }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 50px;
            font-size: 1.3em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        .form-container { max-width: 1000px; margin: 0 auto; }
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        .form-section h3 { color: #667eea; margin-bottom: 20px; font-size: 1.5em; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #333; margin-bottom: 8px; font-size: 0.95em; }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .result-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            margin-top: 15px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .result-item.normal { background: #d4edda; color: #155724; }
        .result-item.warning { background: #fff3cd; color: #856404; }
        .result-item.danger { background: #f8d7da; color: #721c24; }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 2.5em; margin-bottom: 10px; }
        .stat-card p { font-size: 1.1em; opacity: 0.9; }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .chart-controls { text-align: right; margin-bottom: 15px; }
        .btn-download {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td { padding: 12px 15px; border-bottom: 1px solid #dee2e6; }
        tbody tr:hover { background: #f8f9fa; }
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Nutrition Care Plan</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            <button class="nav-tab" onclick="switchTab('form')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('data')">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <div class="home-container">
                <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Nutrition Care Plan</h2>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                <button class="btn-primary" onclick="switchTab('form')">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>

        <!-- Form Tab -->
        <div id="form" class="tab-content">
            <div class="form-container">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                
                <form id="patientForm">
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                    <div class="form-section">
                        <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• *</label>
                                <input type="date" name="recordDate" required>
                            </div>
                            <div class="form-group">
                                <label>HN *</label>
                                <input type="text" name="hn" placeholder="‡πÄ‡∏•‡∏Ç HN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ä‡∏∑‡πà‡∏≠ *</label>
                                <input type="text" name="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" required>
                            </div>
                            <div class="form-group">
                                <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                                <input type="text" name="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" required>
                            </div>
                            <div class="form-group">
                                <label>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ *</label>
                                <select name="ward" required>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                                    <option value="MED">MED</option>
                                    <option value="SURG">SURG</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="8">8</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ -->
                    <div class="form-section">
                        <h3>ü©∫ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ</h3>
                        <div class="form-group">
                            <label>Diagnosis (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å) *</label>
                            <select name="mainDiagnosis" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å --</option>
                                <option value="Stroke">Stroke (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Parkinson">Parkinson's Disease</option>
                                <option value="Alzheimer">Alzheimer's Disease</option>
                                <option value="Epilepsy">Epilepsy (‡πÇ‡∏£‡∏Ñ‡∏•‡∏°‡∏ä‡∏±‡∏Å)</option>
                                <option value="Multiple Sclerosis">Multiple Sclerosis</option>
                                <option value="Brain Tumor">Brain Tumor (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≠‡∏Å‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Meningitis">Meningitis (‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö)</option>
                                <option value="Encephalitis">Encephalitis (‡∏™‡∏°‡∏≠‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö)</option>
                                <option value="Migraine">Migraine (‡πÑ‡∏°‡πÄ‡∏Å‡∏£‡∏ô)</option>
                                <option value="Other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" name="otherDiagnosis" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                        </div>
                        
                        <div class="form-group">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="dm" name="chronic" value="DM">
                                    <label for="dm">DM (‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="dlp" name="chronic" value="DLP">
                                    <label for="dlp">DLP (‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ht" name="chronic" value="HT">
                                    <label for="ht">HT (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="gout" name="chronic" value="GOUT">
                                    <label for="gout">GOUT (‡πÄ‡∏Å‡πä‡∏≤‡∏ó‡πå)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ckd" name="chronic" value="CKD">
                                    <label for="ckd">CKD (‡πÑ‡∏ï‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cad" name="chronic" value="CAD">
                                    <label for="cad">CAD (‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="copd" name="chronic" value="COPD">
                                    <label for="copd">COPD (‡∏õ‡∏≠‡∏î‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cirrhosis" name="chronic" value="Cirrhosis">
                                    <label for="cirrhosis">Cirrhosis (‡∏ï‡∏±‡∏ö‡πÅ‡∏Ç‡πá‡∏á)</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                            <input type="text" name="otherChronic" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                        </div>
                    </div>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ -->
                    <div class="form-section">
                        <h3>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô NAF (0-15) *</label>
                                <input type="number" name="nafScore" min="0" max="15" step="1" required onchange="calculateNAF()">
                            </div>
                            <div class="form-group">
                                <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg) *</label>
                                <input type="number" name="weight" step="0.1" required onchange="calculateBMI()">
                            </div>
                            <div class="form-group">
                                <label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm) *</label>
                                <input type="number" name="height" step="0.1" required onchange="calculateBMI()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Albumin (g/dL)</label>
                                <input type="number" name="albumin" step="0.1" onchange="checkAlbumin()">
                            </div>
                            <div class="form-group">
                                <label>Total Protein (g/dL)</label>
                                <input type="number" name="totalProtein" step="0.1" onchange="checkTotalProtein()">
                            </div>
                        </div>

                        <div class="result-box" id="assessmentResults">
                            <h4 style="margin-bottom: 15px; color: #667eea;">üìã ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h4>
                            <div class="result-item" id="nafResult">
                                <span>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á NAF:</span>
                                <strong>-</strong>
                            </div>
                            <div class="result-item" id="bmiResult">
                                <span>BMI:</span>
                                <strong>-</strong>
                            </div>
                            <div class="result-item" id="albuminResult">
                                <span>Albumin:</span>
                                <strong>-</strong>
                            </div>
                            <div class="result-item" id="proteinResult">
                                <span>Total Protein:</span>
                                <strong>-</strong>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° -->
                    <div class="form-section">
                        <h3>üìÖ ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° / Follow up</label>
                                <input type="date" name="followUpDate">
                            </div>
                            <div class="form-group">
                                <label>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</label>
                                <select name="followUpResult">
                                    <option value="">-- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° --</option>
                                    <option value="‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô">‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô</option>
                                    <option value="‡∏Ñ‡∏á‡∏ó‡∏µ‡πà">‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</option>
                                    <option value="‡πÅ‡∏¢‡πà‡∏•‡∏á">‡πÅ‡∏¢‡πà‡∏•‡∏á</option>
                                    <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 30px;">üìä Dashboard - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalPatients">-</h3>
                    <p>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 id="needFollowUp">-</h3>
                    <p>‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="followed">-</h3>
                    <p>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</p>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-controls">
                    <button class="btn-download" onclick="downloadChart('nafChart')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                </div>
                <h3>‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (NAF Score)</h3>
                <canvas id="nafChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-controls">
                    <button class="btn-download" onclick="downloadChart('wardChart')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                </div>
                <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏≠</h3>
                <canvas id="wardChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-controls">
                    <button class="btn-download" onclick="downloadChart('bmiChart')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                </div>
                <h3>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤ BMI</h3>
                <canvas id="bmiChart"></canvas>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <div class="chart-container">
                    <div class="chart-controls">
                        <button class="btn-download" onclick="downloadChart('albuminChart')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                    </div>
                    <h3>‡∏Ñ‡πà‡∏≤ Albumin</h3>
                    <canvas id="albuminChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-controls">
                        <button class="btn-download" onclick="downloadChart('proteinChart')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                    </div>
                    <h3>‡∏Ñ‡πà‡∏≤ Total Protein</h3>
                    <canvas id="proteinChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table Tab -->
        <div id="data" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="table-container">
                <div class="loading" id="tableLoading">
                    <div class="spinner"></div>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
                <table id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th>HN</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                            <th>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å</th>
                            <th>NAF Score</th>
                            <th>BMI</th>
                            <th>Albumin</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQHIqUx-gvsmYneQsyhT7s3X7A5hj4-Y_9dWQW204HK7L2fIEO9EHFFfO1k0uK-HM/exec';
        
        let allData = [];
        let charts = {};

        // Switch Tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'data') {
                loadTableData();
            }
        }

        // Set default date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="recordDate"]').value = today;
        });

        // Calculate NAF Score Result
        function calculateNAF() {
            const score = parseInt(document.querySelector('input[name="nafScore"]').value) || 0;
            const resultDiv = document.getElementById('nafResult');
            
            let status, className, followUp = '';
            
            if (score >= 0 && score <= 5) {
                status = 'Normal - Mild Malnutrition (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á-‡∏û‡∏ö‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏∏‡∏û‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)';
                className = 'normal';
            } else if (score >= 6 && score <= 10) {
                status = 'Moderate Malnutrition (‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏∏‡∏û‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)';
                className = 'warning';
                followUp = ' - ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
            } else if (score >= 11) {
                status = 'Severe Malnutrition (‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏∏‡∏û‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á)';
                className = 'danger';
                followUp = ' - ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
            }
            
            resultDiv.className = 'result-item ' + className;
            resultDiv.innerHTML = '<span>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á NAF (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ' + score + '):</span><strong>' + status + followUp + '</strong>';
        }

        // Calculate BMI
        function calculateBMI() {
            const weight = parseFloat(document.querySelector('input[name="weight"]').value);
            const height = parseFloat(document.querySelector('input[name="height"]').value);
            
            if (weight && height) {
                const bmi = weight / Math.pow(height / 100, 2);
                const resultDiv = document.getElementById('bmiResult');
                
                let status, className;
                if (bmi < 18.5) {
                    status = '‡∏ú‡∏≠‡∏° (Underweight)';
                    className = 'warning';
                } else if (bmi >= 18.5 && bmi < 23) {
                    status = '‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)';
                    className = 'normal';
                } else if (bmi >= 23 && bmi < 25) {
                    status = '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô (Overweight)';
                    className = 'warning';
                } else if (bmi >= 25 && bmi < 30) {
                    status = '‡∏≠‡πâ‡∏ß‡∏ô (Obese I)';
                    className = 'danger';
                } else {
                    status = '‡∏≠‡πâ‡∏ß‡∏ô‡∏°‡∏≤‡∏Å (Obese II)';
                    className = 'danger';
                }
                
                resultDiv.className = 'result-item ' + className;
                resultDiv.innerHTML = '<span>BMI:</span><strong>' + bmi.toFixed(2) + ' - ' + status + '</strong>';
            }
        }

        // Check Albumin
        function checkAlbumin() {
            const albumin = parseFloat(document.querySelector('input[name="albumin"]').value);
            const resultDiv = document.getElementById('albuminResult');
            
            if (albumin) {
                let status, className;
                if (albumin < 3.5) {
                    status = '‡∏ï‡πà‡∏≥ (Low)';
                    className = 'danger';
                } else if (albumin >= 3.5 && albumin <= 5.2) {
                    status = '‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)';
                    className = 'normal';
                } else {
                    status = '‡∏™‡∏π‡∏á (High)';
                    className = 'warning';
                }
                
                resultDiv.className = 'result-item ' + className;
                resultDiv.innerHTML = '<span>Albumin:</span><strong>' + albumin.toFixed(1) + ' g/dL - ' + status + ' (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥: 3.5-5.2)</strong>';
            }
        }

        // Check Total Protein
        function checkTotalProtein() {
            const protein = parseFloat(document.querySelector('input[name="totalProtein"]').value);
            const resultDiv = document.getElementById('proteinResult');
            
            if (protein) {
                let status, className;
                if (protein < 6.6) {
                    status = '‡∏ï‡πà‡∏≥ (Low)';
                    className = 'danger';
                } else if (protein >= 6.6 && protein <= 8.3) {
                    status = '‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)';
                    className = 'normal';
                } else {
                    status = '‡∏™‡∏π‡∏á (High)';
                    className = 'warning';
                }
                
                resultDiv.className = 'result-item ' + className;
                resultDiv.innerHTML = '<span>Total Protein:</span><strong>' + protein.toFixed(1) + ' g/dL - ' + status + ' (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥: 6.6-8.3)</strong>';
            }
        }

        // Form Submit
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {};
            
            formData.forEach(function(value, key) {
                if (key !== 'chronic') {
                    data[key] = value;
                }
            });
            
            const chronicDiseases = [];
            document.querySelectorAll('input[name="chronic"]:checked').forEach(function(cb) {
                chronicDiseases.push(cb.value);
            });
            if (data.otherChronic) {
                chronicDiseases.push(data.otherChronic);
            }
            data.chronicDiseases = chronicDiseases.join(', ');
            
            const weight = parseFloat(data.weight);
            const height = parseFloat(data.height);
            data.bmi = (weight / Math.pow(height / 100, 2)).toFixed(2);
            
            const nafScore = parseInt(data.nafScore);
            const hasFollowUpResult = data.followUpResult && data.followUpResult !== '';
            
            if (hasFollowUpResult) {
                data.isFollowed = 'Yes';
            } else if (nafScore >= 6) {
                data.isFollowed = 'No';
            } else {
                data.isFollowed = 'Pending';
            }
            
            data.createdAt = new Date().toISOString();
            
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                didOpen: function() {
                    Swal.showLoading();
                }
            });
            
            sendDataToGoogleSheet(data).then(function() {
                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                
                e.target.reset();
                const today = new Date().toISOString().split('T')[0];
                document.querySelector('input[name="recordDate"]').value = today;
                
                document.getElementById('assessmentResults').querySelectorAll('.result-item').forEach(function(item) {
                    item.className = 'result-item';
                    const strong = item.querySelector('strong');
                    if (strong) strong.textContent = '-';
                });
                
            }).catch(function(error) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                console.error('Error:', error);
            });
        });

        // Send data using JSONP
        function sendDataToGoogleSheet(data) {
            return new Promise(function(resolve, reject) {
                const callbackName = 'jsonpCallback_' + Date.now();
                const script = document.createElement('script');
                const params = new URLSearchParams(data).toString();
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (response.result === 'success') {
                        resolve(response);
                    } else {
                        reject(new Error(response.error || 'Unknown error'));
                    }
                };
                
                script.src = SCRIPT_URL + '?' + params + '&callback=' + callbackName + '&timestamp=' + Date.now();
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Network error'));
                };
                
                document.body.appendChild(script);
            });
        }

        // Load Dashboard
        function loadDashboard() {
            console.log('Loading dashboard...');
            
            if (allData.length === 0) {
                console.log('No data in memory, loading from server...');
                
                loadTableData().then(function(data) {
                    console.log('Data loaded for dashboard:', data.length, 'records');
                    
                    if (data.length === 0) {
                        console.log('No data available');
                        document.getElementById('totalPatients').textContent = '0';
                        document.getElementById('needFollowUp').textContent = '0';
                        document.getElementById('followed').textContent = '0';
                        return;
                    }
                    
                    updateDashboardStats(data);
                    createAllCharts();
                    
                }).catch(function(error) {
                    console.error('Failed to load data for dashboard:', error);
                    document.getElementById('totalPatients').textContent = 'Error';
                    document.getElementById('needFollowUp').textContent = 'Error';
                    document.getElementById('followed').textContent = 'Error';
                });
                
            } else {
                console.log('Using cached data:', allData.length, 'records');
                updateDashboardStats(allData);
                createAllCharts();
            }
        }

        function updateDashboardStats(data) {
            const totalPatients = data.length;
            const needFollowUp = data.filter(function(d) { return d.isFollowed === 'No'; }).length;
            const followed = data.filter(function(d) { return d.isFollowed === 'Yes'; }).length;
            
            document.getElementById('totalPatients').textContent = totalPatients;
            document.getElementById('needFollowUp').textContent = needFollowUp;
            document.getElementById('followed').textContent = followed;
        }

        function createAllCharts() {
            createNAFChart();
            createWardChart();
            createBMIChart();
            createAlbuminChart();
            createProteinChart();
        }

        // Load Table Data
        function loadTableData() {
            return new Promise(function(resolve, reject) {
                const loading = document.getElementById('tableLoading');
                const table = document.getElementById('dataTable');
                const tbody = document.getElementById('dataTableBody');
                
                loading.style.display = 'block';
                loading.innerHTML = '<div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
                table.style.display = 'none';
                
                const oldScript = document.getElementById('jsonp-script');
                if (oldScript) {
                    document.body.removeChild(oldScript);
                }
                
                const callbackName = 'jsonpCallback_getData_' + Date.now();
                
                console.log('Creating callback:', callbackName);
                
                const timeoutId = setTimeout(function() {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        const script = document.getElementById('jsonp-script');
                        if (script) {
                            document.body.removeChild(script);
                        }
                        loading.innerHTML = '<p style="color: red;">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br><button class="btn-primary" style="margin-top: 20px;" onclick="loadTableData()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button></p>';
                        reject(new Error('Timeout'));
                    }
                }, 15000);
                
                window[callbackName] = function(response) {
                    try {
                        clearTimeout(timeoutId);
                        
                        console.log('Callback received:', response);
                        
                        delete window[callbackName];
                        const script = document.getElementById('jsonp-script');
                        if (script && script.parentNode) {
                            document.body.removeChild(script);
                        }
                        
                        if (response.result === 'success') {
                            allData = response.data || [];
                            
                            console.log('Data loaded successfully:', allData.length, 'records');
                            
                            tbody.innerHTML = '';
                            
                            if (allData.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢<br><button class="btn-primary" style="margin-top: 20px;" onclick="switchTab(\'form\')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</button></td></tr>';
                            } else {
                                allData.forEach(function(row) {
                                    const tr = document.createElement('tr');
                                    
                                    const nafScore = parseInt(row.nafScore) || 0;
                                    const nafBadge = nafScore >= 6 ? 'badge-danger' : 'badge-success';
                                    
                                    let followBadge = 'badge-warning';
                                    if (row.isFollowed === 'Yes') followBadge = 'badge-success';
                                    else if (row.isFollowed === 'No') followBadge = 'badge-danger';
                                    
                                    let displayDate = row.recordDate || '-';
                                    if (displayDate !== '-' && displayDate) {
                                        try {
                                            const date = new Date(displayDate);
                                            if (!isNaN(date.getTime())) {
                                                displayDate = date.toLocaleDateString('th-TH', {
                                                    year: 'numeric',
                                                    month: 'short',
                                                    day: 'numeric'
                                                });
                                            }
                                        } catch (e) {}
                                    }
                                    
                                    const fullName = ((row.firstName || '') + ' ' + (row.lastName || '')).trim() || '-';
                                    
                                    tr.innerHTML = '<td>' + displayDate + '</td>' +
                                        '<td>' + (row.hn || '-') + '</td>' +
                                        '<td>' + fullName + '</td>' +
                                        '<td>' + (row.ward || '-') + '</td>' +
                                        '<td>' + (row.mainDiagnosis || '-') + '</td>' +
                                        '<td><span class="badge ' + nafBadge + '">' + (row.nafScore || '-') + '</span></td>' +
                                        '<td>' + (row.bmi || '-') + '</td>' +
                                        '<td>' + (row.albumin || '-') + '</td>' +
                                        '<td><span class="badge ' + followBadge + '">' + (row.isFollowed || '-') + '</span></td>';
                                    
                                    tbody.appendChild(tr);
                                });
                            }
                            
                            loading.style.display = 'none';
                            table.style.display = 'table';
                            
                            resolve(allData);
                            
                        } else {
                            throw new Error(response.error || 'Unknown error');
                        }
                        
                    } catch (error) {
                        clearTimeout(timeoutId);
                        console.error('Error in callback:', error);
                        loading.innerHTML = '<p style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message + '<br><button class="btn-primary" style="margin-top: 20px;" onclick="loadTableData()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button></p>';
                        reject(error);
                    }
                };
                
                const script = document.createElement('script');
                script.id = 'jsonp-script';
                script.src = SCRIPT_URL + '?action=getData&callback=' + callbackName + '&timestamp=' + Date.now();
                
                console.log('Loading from:', script.src);
                
                script.onerror = function() {
                    clearTimeout(timeoutId);
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    console.error('Script load error');
                    loading.innerHTML = '<p style="color: red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ<br><button class="btn-primary" style="margin-top: 20px;" onclick="loadTableData()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button></p>';
                    reject(new Error('Script load error'));
                };
                
                document.body.appendChild(script);
            });
        }

        // Create Charts
        function createNAFChart() {
            const ctx = document.getElementById('nafChart').getContext('2d');
            
            const nafCounts = {
                'Normal (0-5)': 0,
                'Moderate (6-10)': 0,
                'Severe (‚â•11)': 0
            };
            
            allData.forEach(function(d) {
                const score = parseInt(d.nafScore) || 0;
                if (score >= 0 && score <= 5) nafCounts['Normal (0-5)']++;
                else if (score >= 6 && score <= 10) nafCounts['Moderate (6-10)']++;
                else if (score >= 11) nafCounts['Severe (‚â•11)']++;
            });
            
            if (charts.nafChart) charts.nafChart.destroy();
            
            charts.nafChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(nafCounts),
                    datasets: [{
                        data: Object.values(nafCounts),
                        backgroundColor: ['#4ade80', '#fbbf24', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createWardChart() {
            const ctx = document.getElementById('wardChart').getContext('2d');
            
            const wardCounts = {};
            allData.forEach(function(d) {
                wardCounts[d.ward] = (wardCounts[d.ward] || 0) + 1;
            });
            
            if (charts.wardChart) charts.wardChart.destroy();
            
            charts.wardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(wardCounts),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢',
                        data: Object.values(wardCounts),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createBMIChart() {
            const ctx = document.getElementById('bmiChart').getContext('2d');
            
            const bmiCounts = {
                '‡∏ú‡∏≠‡∏° (<18.5)': 0,
                '‡∏õ‡∏Å‡∏ï‡∏¥ (18.5-22.9)': 0,
                '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô (23-24.9)': 0,
                '‡∏≠‡πâ‡∏ß‡∏ô (‚â•25)': 0
            };
            
            allData.forEach(function(d) {
                const bmi = parseFloat(d.bmi);
                if (bmi < 18.5) bmiCounts['‡∏ú‡∏≠‡∏° (<18.5)']++;
                else if (bmi >= 18.5 && bmi < 23) bmiCounts['‡∏õ‡∏Å‡∏ï‡∏¥ (18.5-22.9)']++;
                else if (bmi >= 23 && bmi < 25) bmiCounts['‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô (23-24.9)']++;
                else if (bmi >= 25) bmiCounts['‡∏≠‡πâ‡∏ß‡∏ô (‚â•25)']++;
            });
            
            if (charts.bmiChart) charts.bmiChart.destroy();
            
            charts.bmiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(bmiCounts),
                    datasets: [{
                        data: Object.values(bmiCounts),
                        backgroundColor: ['#60a5fa', '#4ade80', '#fbbf24', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function createAlbuminChart() {
            const ctx = document.getElementById('albuminChart').getContext('2d');
            
            const albuminData = allData.filter(function(d) { return d.albumin; }).map(function(d) { return parseFloat(d.albumin); });
            const albuminCounts = {
                '‡∏ï‡πà‡∏≥ (<3.5)': albuminData.filter(function(v) { return v < 3.5; }).length,
                '‡∏õ‡∏Å‡∏ï‡∏¥ (3.5-5.2)': albuminData.filter(function(v) { return v >= 3.5 && v <= 5.2; }).length,
                '‡∏™‡∏π‡∏á (>5.2)': albuminData.filter(function(v) { return v > 5.2; }).length
            };
            
            if (charts.albuminChart) charts.albuminChart.destroy();
            
            charts.albuminChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(albuminCounts),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢',
                        data: Object.values(albuminCounts),
                        backgroundColor: ['#ef4444', '#4ade80', '#fbbf24']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createProteinChart() {
            const ctx = document.getElementById('proteinChart').getContext('2d');
            
            const proteinData = allData.filter(function(d) { return d.totalProtein; }).map(function(d) { return parseFloat(d.totalProtein); });
            const proteinCounts = {
                '‡∏ï‡πà‡∏≥ (<6.6)': proteinData.filter(function(v) { return v < 6.6; }).length,
                '‡∏õ‡∏Å‡∏ï‡∏¥ (6.6-8.3)': proteinData.filter(function(v) { return v >= 6.6 && v <= 8.3; }).length,
                '‡∏™‡∏π‡∏á (>8.3)': proteinData.filter(function(v) { return v > 8.3; }).length
            };
            
            if (charts.proteinChart) charts.proteinChart.destroy();
            
            charts.proteinChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(proteinCounts),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢',
                        data: Object.values(proteinCounts),
                        backgroundColor: ['#ef4444', '#4ade80', '#fbbf24']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Download Chart
        function downloadChart(chartId) {
            const canvas = document.getElementById(chartId);
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = chartId + '_' + new Date().getTime() + '.png';
            link.href = url;
            link.click();
        }
    </script>
</body>
</html>
