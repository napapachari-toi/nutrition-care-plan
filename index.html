<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Nutrition Care Plan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .welcome-section {
            text-align: center;
            padding: 60px 20px;
        }

        .welcome-section h2 {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            margin: 0;
            font-weight: bold;
            color: #667eea;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            min-width: 120px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
        }

        .status-followed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            margin: 0;
            font-weight: bold;
            color: #667eea;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            min-width: 120px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
        }

        .status-followed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 15px 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.3s;
            font-size: 13px;
            white-space: nowrap;
            text-align: center;
            padding: 12px 8px;
        }

        th:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
            font-size: 0.7em;
            margin-left: 4px;
        }

        th.sort-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
            font-size: 0.7em;
            margin-left: 4px;
        }

        th.sort-desc::after {
            content: ' ‚ñº';
            opacity: 1;
            font-size: 0.7em;
            margin-left: 4px;
        }

        tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-width: 40px;
            text-align: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-dots {
            padding: 8px;
            color: #667eea;
            font-weight: bold;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-selector label {
            margin: 0;
            color: #667eea;
            font-weight: bold;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            background: white;
        }

        .result-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .result-label {
            font-weight: bold;
            color: #495057;
        }

        .result-value {
            color: #667eea;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .top5-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .top5-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .top5-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .top5-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .top5-rank {
            font-weight: bold;
            color: #667eea;
            margin-right: 10px;
        }

        .top5-name {
            flex: 1;
        }

        .top5-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            max-width: 350px;
            height: auto;
            margin: 0 auto;
        }
.chart-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            max-width: 350px;
            height: auto;
            margin: 0 auto;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            header {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 15px;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-group select,
            .filter-group input {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top5-container {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 10px;
            }

            th, td {
                padding: 8px 4px;
                font-size: 10px;
            }

            th {
                font-size: 10px;
                min-width: 50px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .pagination-container {
                flex-direction: column;
                gap: 10px;
            }

            .pagination-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2.5em;
            }
        }

        /* Tablet Responsive */
        @media (min-width: 769px) and (max-width: 1024px) {
            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 6px;
            }
        }
  </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üè• Nutrition Care Plan</h1>
            <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
        </header>

        <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('home', this)">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    <button class="nav-tab" onclick="showPage('form', this)">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="nav-tab" onclick="showPage('dashboard', this)">üìä Dashboard</button>
    <button class="nav-tab" onclick="showPage('table', this)">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

        <div class="content">
            <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
            <div id="home" class="page active">
                <div class="welcome-section">
                    <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Nutrition Care Plan</h2>
                    <p style="color: #666; margin-bottom: 30px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                    <button class="btn btn-primary" onclick="document.querySelectorAll('.nav-tab')[1].click()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                    <button class="btn btn-success" onclick="loadAllData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>

            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div id="form" class="page">
                <h2 style="margin-bottom: 20px;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                <div id="alertContainer"></div>
                
                <form id="patientForm">
                    <input type="hidden" id="editRowNumber" value="">
                    
                    <div class="form-section">
                        <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• *</label>
                                <input type="date" id="recordDate" required>
                            </div>
                            <div class="form-group">
                                <label>HN *</label>
                                <input type="text" id="hn" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ä‡∏∑‡πà‡∏≠ *</label>
                                <input type="text" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                                <input type="text" id="lastName" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ *</label>
                            <select id="ward" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                                <option value="MED">MED</option>
                                <option value="SURG">SURG</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ü©∫ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ</h3>
                        <div class="form-group">
                            <label>Diagnosis (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å) *</label>
                            <select id="diagnosis" required onchange="toggleOtherDiagnosis()">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å --</option>
                                <option value="Stroke">Stroke (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Parkinson's Disease">Parkinson's Disease</option>
                                <option value="Alzheimer's Disease">Alzheimer's Disease</option>
                                <option value="Epilepsy">Epilepsy (‡πÇ‡∏£‡∏Ñ‡∏•‡∏°‡∏ä‡∏±‡∏Å)</option>
                                <option value="Multiple Sclerosis">Multiple Sclerosis</option>
                                <option value="Brain Tumor">Brain Tumor (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≠‡∏Å‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Meningitis">Meningitis (‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö)</option>
                                <option value="Encephalitis">Encephalitis (‡∏™‡∏°‡∏≠‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö)</option>
                                <option value="Migraine">Migraine (‡πÑ‡∏°‡πÄ‡∏Å‡∏£‡∏ô)</option>
                                <option value="Meningioma">Meningioma (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≠‡∏Å‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Spinal stenosis">Spinal stenosis (‡πÑ‡∏Ç‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏µ‡∏ö)</option>
                                <option value="Spine tumors">Spine tumors (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á)</option>
                                <option value="Spondylolisthesis">Spondylolisthesis (‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô)</option>
                                <option value="Cerebral aneurysm">Cerebral aneurysm (‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÇ‡∏õ‡πà‡∏á‡∏û‡∏≠‡∏á)</option>
                                <option value="Basal Ganglia Hemorrhage">Basal Ganglia Hemorrhage (‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô Basal Ganglia)</option>
                                <option value="Intracerebral Hemorrhage">Intracerebral Hemorrhage (‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Intraventricular Hemorrhage">Intraventricular Hemorrhage (‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Subarachnoid Hemorrhage">Subarachnoid Hemorrhage (‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏ï‡πâ‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Subdural Hematoma">Subdural Hematoma (‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ñ‡∏±‡πà‡∏á‡πÉ‡∏ï‡πâ‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Failed Back Surgery">Failed Back Surgery (‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏´‡∏•‡∏±‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="form-group" id="otherDiagnosisGroup" style="display: none;">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" id="otherDiagnosis">
                        </div>
                        <div class="form-group">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="dm" value="DM">
                                    <label for="dm">DM (‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="dlp" value="DLP">
                                    <label for="dlp">DLP (‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ht" value="HT">
                                    <label for="ht">HT (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="gout" value="GOUT">
                                    <label for="gout">GOUT (‡πÄ‡∏Å‡πä‡∏≤‡∏ó‡πå)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ckd" value="CKD">
                                    <label for="ckd">CKD (‡πÑ‡∏ï‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cad" value="CAD">
                                    <label for="cad">CAD (‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="copd" value="COPD">
                                    <label for="copd">COPD (‡∏õ‡∏≠‡∏î‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cirrhosis" value="Cirrhosis">
                                    <label for="cirrhosis">Cirrhosis (‡∏ï‡∏±‡∏ö‡πÅ‡∏Ç‡πá‡∏á)</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                            <input type="text" id="otherChronicDiseases">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô NAF *</label>
                                <input type="number" id="nafScore" min="0"  required oninput="calculateResults()">
                            </div>
                            <div class="form-group">
                                <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg) *</label>
                                <input type="number" id="weight" step="0.1" required oninput="calculateResults()">
                            </div>
                            <div class="form-group">
                                <label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm) *</label>
                                <input type="number" id="height" step="0.1" required oninput="calculateResults()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Albumin (g/dL)</label>
                                <input type="number" id="albumin" step="0.1" oninput="calculateResults()">
                            </div>
                            <div class="form-group">
                                <label>Total Protein (g/dL)</label>
                                <input type="number" id="totalProtein" step="0.1" oninput="calculateResults()">
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">üìã ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h4>
                        <div class="result-box">
                            <div class="result-item">
                                <span class="result-label">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á NAF:</span>
                                <span class="result-value" id="nafResult">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">BMI:</span>
                                <span class="result-value" id="bmiResult">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Albumin:</span>
                                <span class="result-value" id="albuminResult">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Total Protein:</span>
                                <span class="result-value" id="totalProteinResult">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üìÖ ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° / Follow up</label>
                                <input type="date" id="followUpDate">
                            </div>
                            <div class="form-group">
                                <label>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</label>
                                <select id="followUpResult">
                                    <option value="">-- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° --</option>
                                    <option value="‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô">‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô</option>
                                    <option value="‡∏Ñ‡∏á‡∏ó‡∏µ‡πà">‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</option>
                                    <option value="‡πÅ‡∏¢‡πà‡∏•‡∏á">‡πÅ‡∏¢‡πà‡∏•‡∏á</option>
                                    <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <textarea id="followUpDetails" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" id="submitBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()" id="cancelBtn" style="display: none;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>

<!-- Dashboard -->
            <div id="dashboard" class="page">
                <h2 style="margin-bottom: 20px;">üìä Dashboard - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>üè• ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
                           <select id="dashboardWardFilter" onchange="applyDashboardFilter()">
                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="MED">MED</option>
                                <option value="SURG">SURG</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>üóìÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:</label>
                            <select id="dashboardStartMonth">
                                <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="dashboardStartYear">
                                <option value="">‡∏õ‡∏µ</option>
                            </select>
                        </div>
                        <span style="margin: 0 5px;">‡∏ñ‡∏∂‡∏á</span>
                        <div class="filter-group">
                            <select id="dashboardEndMonth">
                                <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="dashboardEndYear">
                                <option value="">‡∏õ‡∏µ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="applyDashboardFilter()">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button class="btn btn-secondary" onclick="clearDashboardFilter()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    </div>
                    <div id="dashboardFilterInfo" style="margin-top: 10px; color: #667eea; font-weight: bold;"></div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-number" id="totalPatients">-</div>
                        <div class="stat-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-number" id="needFollowUp">-</div>
                        <div class="stat-label">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="stat-number" id="followedUp">-</div>
                        <div class="stat-label">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                </div>

                <!-- Top 5 Diagnosis ‡πÅ‡∏•‡∏∞ ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß -->
                <div class="top5-container">
                    <div class="top5-card">
                        <h3>üèÜ Top 5 Diagnosis (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å)</h3>
                        <div id="top5Diagnosis"></div>
                    </div>
                    <div class="top5-card">
                        <h3>üèÜ Top 5 ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</h3>
                        <div id="top5Chronic"></div>
                    </div>
                </div>

                <!-- ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü -->
                <div class="filter-section" style="margin-bottom: 20px;">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>üìä ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü:</label>
                            <select id="chartType" onchange="updateChartDisplay()">
                                <option value="pie">‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (Pie)</option>
                                <option value="donut">‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó (Donut)</option>
                                <option value="bar">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>üìÖ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</label>
                            <select id="comparisonType" onchange="updateChartDisplay()">
                                <option value="none">‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option>
                                <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="chartsContainer"></div>
            </div>
            <!-- ‡∏õ‡∏¥‡∏î Dashboard ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div id="table" class="page">
                <h2 style="margin-bottom: 20px;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
                <div class="filter-section" style="margin-bottom: 15px;">
                    <div class="filter-row">
                        <div class="filter-group" style="flex: 1; max-width: 400px;">
                            <label>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label>
                            <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" 
                                   style="width: 100%;" oninput="applySearch()">
                        </div>
                        <button class="btn btn-secondary" onclick="clearSearch()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                    <div id="searchInfo" style="margin-top: 10px; color: #667eea; font-weight: bold;"></div>
                </div>
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>üè• ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
                           <select id="tableWardFilter" onchange="applyTableFilter()">
                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="MED">MED</option>
                                <option value="SURG">SURG</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>üóìÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:</label>
                            <select id="tableStartMonth">
                                <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="tableStartYear">
                                <option value="">‡∏õ‡∏µ</option>
                            </select>
                        </div>
                        <span style="margin: 0 5px;">‡∏ñ‡∏∂‡∏á</span>
                        <div class="filter-group">
                            <select id="tableEndMonth">
                                <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="tableEndYear">
                                <option value="">‡∏õ‡∏µ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="applyTableFilter()">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button class="btn btn-secondary" onclick="clearTableFilter()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                        <button class="btn btn-success" onclick="loadAllData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                    <div id="tableFilterInfo" style="margin-top: 10px; color: #667eea; font-weight: bold;"></div>
                </div>
                
                <div id="tableContainer"></div>
                
                <!-- Pagination Controls -->
                <div class="pagination-container" id="paginationContainer">
                    <div class="pagination-info" id="paginationInfo"></div>
                    <div class="pagination-controls" id="paginationControls"></div>
                    <div class="page-size-selector">
                        <label>‡πÅ‡∏™‡∏î‡∏á:</label>
                        <select id="pageSize" onchange="changePageSize()">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                        <span style="color: #667eea; font-weight: bold;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πâ‡∏≤</span>
                    </div>
                </div>
            </div>
            <!-- ‡∏õ‡∏¥‡∏î Table ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </div>
        <!-- ‡∏õ‡∏¥‡∏î content ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
    </div>
    <!-- ‡∏õ‡∏¥‡∏î container ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <strong id="deletePatientName"></strong> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <p style="color: #dc3545; margin-top: 10px;">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-danger" onclick="confirmDelete()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà URL ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≤‡∏Å Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5RfYHNaDoWfP2URNOWkIgSEPBHF_R_uB8T8IVXEykveMfXIfP5uc6G73vqJIk3lLK/exec';
        
        let patients = [];
        let filteredPatients = [];
        let searchFilteredPatients = [];
        let deleteRowNumber = null;
        let currentChartType = 'pie'; // pie, donut, bar
        let currentComparisonType = 'none'; // none, monthly, yearly
        
        // Pagination variables
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;
        
        // Sort variables
        let sortColumn = null;
        let sortDirection = 'asc'; // asc or desc
               // Ward filter variable
        let selectedWard = 'all'; // all, MED, SURG, 5, 6, 8

        window.onload = function() {
            setDefaultDate();
            populateYearOptions();
            loadAllData();
        };

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 5 ‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï 2 ‡∏õ‡∏µ)
        function populateYearOptions() {
            const currentYear = new Date().getFullYear();
            const yearSelects = [
                'dashboardStartYear',
                'dashboardEndYear',
                'tableStartYear',
                'tableEndYear'
            ];

            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">‡∏õ‡∏µ</option>';
                
                for (let year = currentYear - 5; year <= currentYear + 2; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
                    select.appendChild(option);
                }
            });
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
        }

        function showPage(pageId, clickedButton) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    
    document.getElementById(pageId).classList.add('active');
    
    // ‡∏´‡∏≤ tab ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° active class
    if (!clickedButton) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ button ‡∏™‡πà‡∏á‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach(tab => {
            if (tab.onclick.toString().includes(`'${pageId}'`)) {
                tab.classList.add('active');
            }
        });
    } else {
        clickedButton.classList.add('active');
    }

    if (pageId === 'dashboard') {
        updateDashboard();
    } else if (pageId === 'table') {
        renderTable();
    }
}

        function toggleOtherDiagnosis() {
            const diagnosis = document.getElementById('diagnosis').value;
            const otherGroup = document.getElementById('otherDiagnosisGroup');
            otherGroup.style.display = diagnosis === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? 'block' : 'none';
        }

        function calculateResults() {
            const nafScore = parseFloat(document.getElementById('nafScore').value) || 0;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            const albumin = parseFloat(document.getElementById('albumin').value) || 0;
            const totalProtein = parseFloat(document.getElementById('totalProtein').value) || 0;

            let nafResult = '-';
            let needFollowUp = false;
            if (nafScore >= 0 && nafScore <= 15) {
                if (nafScore >= 11) {
                    nafResult = 'Severe (‚â•11) - ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
                    needFollowUp = true;
                } else if (nafScore >= 6) {
                    nafResult = 'Moderate (6-10) - ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
                    needFollowUp = true;
                } else {
                    nafResult = '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ (<6)';
                }
            }

            let bmiResult = '-';
            if (weight > 0 && height > 0) {
                const bmi = weight / Math.pow(height / 100, 2);
                let status = '';
                if (bmi < 18.5) status = '‡∏ú‡∏≠‡∏°';
                else if (bmi < 23) status = '‡∏õ‡∏Å‡∏ï‡∏¥';
                else if (bmi < 25) status = '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô';
                else if (bmi < 30) status = '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 1';
                else status = '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 2';
                bmiResult = `${bmi.toFixed(2)} (${status})`;
            }

            let albuminResult = '-';
            if (albumin > 0) {
                if (albumin >= 3.5) albuminResult = `${albumin} (‡∏õ‡∏Å‡∏ï‡∏¥)`;
                else if (albumin >= 3.0) albuminResult = `${albumin} (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)`;
                else albuminResult = `${albumin} (‡∏ï‡πà‡∏≥)`;
            }

            let totalProteinResult = '-';
            if (totalProtein > 0) {
                if (totalProtein >= 6.0 && totalProtein <= 8.3) totalProteinResult = `${totalProtein} (‡∏õ‡∏Å‡∏ï‡∏¥)`;
                else if (totalProtein < 6.0) totalProteinResult = `${totalProtein} (‡∏ï‡πà‡∏≥)`;
                else totalProteinResult = `${totalProtein} (‡∏™‡∏π‡∏á)`;
            }

            document.getElementById('nafResult').textContent = nafResult;
            document.getElementById('bmiResult').textContent = bmiResult;
            document.getElementById('albuminResult').textContent = albuminResult;
            document.getElementById('totalProteinResult').textContent = totalProteinResult;
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏á NAF Result
            const nafResultElement = document.getElementById('nafResult');
            if (needFollowUp) {
                if (nafScore >= 11) {
                    nafResultElement.style.color = '#dc3545'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                    nafResultElement.style.fontWeight = 'bold';
                } else {
                    nafResultElement.style.color = '#ffc107'; // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                    nafResultElement.style.fontWeight = 'bold';
                }
            } else {
                nafResultElement.style.color = '#28a745'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                nafResultElement.style.fontWeight = 'bold';
            }
        }

        function getChronicDiseases() {
            const diseases = [];
            const checkboxes = ['dm', 'dlp', 'ht', 'gout', 'ckd', 'cad', 'copd', 'cirrhosis'];
            checkboxes.forEach(id => {
                if (document.getElementById(id).checked) {
                    diseases.push(document.getElementById(id).value);
                }
            });
            const other = document.getElementById('otherChronicDiseases').value.trim();
            if (other) diseases.push(other);
            return diseases;
        }

        function setChronicDiseases(diseases) {
            const checkboxes = ['dm', 'dlp', 'ht', 'gout', 'ckd', 'cad', 'copd', 'cirrhosis'];
            checkboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
            document.getElementById('otherChronicDiseases').value = '';
            
            if (!diseases) return;
            
            const diseaseArray = Array.isArray(diseases) ? diseases : diseases.split(',').map(d => d.trim());
            const standardDiseases = ['DM', 'DLP', 'HT', 'GOUT', 'CKD', 'CAD', 'COPD', 'Cirrhosis'];
            const otherDiseases = [];
            
            diseaseArray.forEach(disease => {
                const checkbox = checkboxes.find(id => document.getElementById(id).value === disease);
                if (checkbox) {
                    document.getElementById(checkbox).checked = true;
                } else if (disease && !standardDiseases.includes(disease)) {
                    otherDiseases.push(disease);
                }
            });
            
            if (otherDiseases.length > 0) {
                document.getElementById('otherChronicDiseases').value = otherDiseases.join(', ');
            }
        }

        async function loadAllData() {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (data.status === 'success') {
    patients = data.data;
    
    // Debug: ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
    console.log('All patients:', patients);
    console.log('First patient:', patients[0]);
    if (patients.length > 0) {
        console.log('First patient NAF:', patients[0].nafScore, 'Type:', typeof patients[0].nafScore);
    }
                    filteredPatients = patients; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    searchFilteredPatients = patients; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    renderTable();
                    updateDashboard();
                    showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
                } else {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
function applySearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (!searchTerm) {
        searchFilteredPatients = filteredPatients;
        document.getElementById('searchInfo').textContent = '';
    } else {
        searchFilteredPatients = filteredPatients.filter(p => {
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô String ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
            const hn = String(p.hn || '').toLowerCase();
            const firstName = String(p.firstName || '').toLowerCase();
            const lastName = String(p.lastName || '').toLowerCase();
            const fullName = `${firstName} ${lastName}`;
            
            return hn.includes(searchTerm) || 
                   firstName.includes(searchTerm) || 
                   lastName.includes(searchTerm) ||
                   fullName.includes(searchTerm);
        });
        
        document.getElementById('searchInfo').textContent = 
            `üîç ‡∏û‡∏ö ${searchFilteredPatients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${document.getElementById('searchInput').value}"`;
    }
    
    renderTable();
}

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchFilteredPatients = filteredPatients;
            document.getElementById('searchInfo').textContent = '';
            renderTable();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        function filterPatientsByDateRange(startMonth, startYear, endMonth, endYear) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if (!startMonth && !startYear && !endMonth && !endYear) {
                return patients;
            }

            return patients.filter(p => {
                if (!p.recordDate) return false;
                
                const recordDate = new Date(p.recordDate);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1; // 1-12

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö YYYYMM
                const recordYearMonth = recordYear * 100 + recordMonth;
                
                let startYearMonth = null;
                let endYearMonth = null;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                if (startYear && startMonth) {
                    startYearMonth = parseInt(startYear) * 100 + parseInt(startMonth);
                } else if (startYear) {
                    startYearMonth = parseInt(startYear) * 100 + 1; // ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°
                } else if (startMonth) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    startYearMonth = 0;
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                if (endYear && endMonth) {
                    endYearMonth = parseInt(endYear) * 100 + parseInt(endMonth);
                } else if (endYear) {
                    endYearMonth = parseInt(endYear) * 100 + 12; // ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°
                } else if (endMonth) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    endYearMonth = 999999;
                }

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                if (startYearMonth !== null && endYearMonth !== null) {
                    return recordYearMonth >= startYearMonth && recordYearMonth <= endYearMonth;
                } else if (startYearMonth !== null) {
                    return recordYearMonth >= startYearMonth;
                } else if (endYearMonth !== null) {
                    return recordYearMonth <= endYearMonth;
                }
                
                return true;
            });
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard
        function applyDashboardFilter() {
    const startMonth = document.getElementById('dashboardStartMonth').value;
    const startYear = document.getElementById('dashboardStartYear').value;
    const endMonth = document.getElementById('dashboardEndMonth').value;
    const endYear = document.getElementById('dashboardEndYear').value;

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å dropdown
    selectedWard = document.getElementById('dashboardWardFilter').value;

    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    filteredPatients = filterPatientsByDateRange(startMonth, startYear, endMonth, endYear);
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô string ‡πÅ‡∏•‡∏∞ trim ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
    if (selectedWard !== 'all') {
        filteredPatients = filteredPatients.filter(p => {
            const ward = String(p.ward || '').trim();
            return ward === selectedWard;
        });
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const infoDiv = document.getElementById('dashboardFilterInfo');
    if (startMonth || startYear || endMonth || endYear) {
        const monthNames = ['', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', 
                          '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
        
        let startText = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô';
        if (startMonth && startYear) {
            startText = `${monthNames[parseInt(startMonth)]} ${parseInt(startYear) + 543}`;
        } else if (startMonth) {
            startText = monthNames[parseInt(startMonth)];
        } else if (startYear) {
            startText = `‡∏õ‡∏µ ${parseInt(startYear) + 543}`;
        }
        
        let endText = '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
        if (endMonth && endYear) {
            endText = `${monthNames[parseInt(endMonth)]} ${parseInt(endYear) + 543}`;
        } else if (endMonth) {
            endText = monthNames[parseInt(endMonth)];
        } else if (endYear) {
            endText = `‡∏õ‡∏µ ${parseInt(endYear) + 543}`;
        }
        
        let filterText = `üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${startText} ‡∏ñ‡∏∂‡∏á ${endText}`;
        if (selectedWard !== 'all') {
            filterText += ` | ‡∏´‡∏≠ ${selectedWard}`;
        }
        filterText += ` (${filteredPatients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
        
        infoDiv.textContent = filterText;
    } else if (selectedWard !== 'all') {
        infoDiv.textContent = `üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏´‡∏≠ ${selectedWard} (${filteredPatients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
    } else {
        infoDiv.textContent = '';
    }
    
    updateDashboard();
}

        function clearDashboardFilter() {
            document.getElementById('dashboardWardFilter').value = 'all';
            document.getElementById('dashboardStartMonth').value = '';
            document.getElementById('dashboardStartYear').value = '';
            document.getElementById('dashboardEndMonth').value = '';
            document.getElementById('dashboardEndYear').value = '';
            selectedWard = 'all';
            filteredPatients = patients;
            updateDashboard();
            document.getElementById('dashboardFilterInfo').textContent = '';
        }
                
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Table
        function applyTableFilter() {
    const startMonth = document.getElementById('tableStartMonth').value;
    const startYear = document.getElementById('tableStartYear').value;
    const endMonth = document.getElementById('tableEndMonth').value;
    const endYear = document.getElementById('tableEndYear').value;
    
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
    selectedWard = document.getElementById('tableWardFilter').value;
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    filteredPatients = filterPatientsByDateRange(startMonth, startYear, endMonth, endYear);
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô string ‡πÅ‡∏•‡∏∞ trim ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
    if (selectedWard !== 'all') {
        filteredPatients = filteredPatients.filter(p => {
            const ward = String(p.ward || '').trim();
            return ward === selectedWard;
        });
    }
    
    // ‡∏ô‡∏≥ filter ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    if (searchTerm) {
        searchFilteredPatients = filteredPatients.filter(p => {
            const hn = (p.hn || '').toLowerCase();
            const firstName = (p.firstName || '').toLowerCase();
            const lastName = (p.lastName || '').toLowerCase();
            const fullName = `${firstName} ${lastName}`;
            
            return hn.includes(searchTerm) || 
                   firstName.includes(searchTerm) || 
                   lastName.includes(searchTerm) ||
                   fullName.includes(searchTerm);
        });
    } else {
        searchFilteredPatients = filteredPatients;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const infoDiv = document.getElementById('tableFilterInfo');
            if (startMonth || startYear || endMonth || endYear) {
                const monthNames = ['', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', 
                                  '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                
                let startText = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô';
                if (startMonth && startYear) {
                    startText = `${monthNames[parseInt(startMonth)]} ${parseInt(startYear) + 543}`;
                } else if (startMonth) {
                    startText = monthNames[parseInt(startMonth)];
                } else if (startYear) {
                    startText = `‡∏õ‡∏µ ${parseInt(startYear) + 543}`;
                }
                
                let endText = '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
                if (endMonth && endYear) {
                    endText = `${monthNames[parseInt(endMonth)]} ${parseInt(endYear) + 543}`;
                } else if (endMonth) {
                    endText = monthNames[parseInt(endMonth)];
                } else if (endYear) {
                    endText = `‡∏õ‡∏µ ${parseInt(endYear) + 543}`;
                }
                
                infoDiv.textContent = `üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${startText} ‡∏ñ‡∏∂‡∏á ${endText} (${filteredPatients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
    } else {
        infoDiv.textContent = '';
    }
    
    renderTable();
}
                
        function clearTableFilter() {
            document.getElementById('tableWardFilter').value = 'all';
            document.getElementById('tableStartMonth').value = '';
            document.getElementById('tableStartYear').value = '';
            document.getElementById('tableEndMonth').value = '';
            document.getElementById('tableEndYear').value = '';
            selectedWard = 'all';
            filteredPatients = patients;
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (searchTerm) {
                applySearch();
            } else {
                searchFilteredPatients = patients;
                renderTable();
            }
            
            document.getElementById('tableFilterInfo').textContent = '';
        }

        document.getElementById('patientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const diagnosis = document.getElementById('diagnosis').value;
            const finalDiagnosis = diagnosis === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? document.getElementById('otherDiagnosis').value : diagnosis;
            const chronicDiseases = getChronicDiseases().join(', ');

            const formData = {
                action: document.getElementById('editRowNumber').value ? 'update' : 'add',
                rowNumber: document.getElementById('editRowNumber').value || '',
                recordDate: document.getElementById('recordDate').value,
                hn: document.getElementById('hn').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                ward: document.getElementById('ward').value,
                diagnosis: finalDiagnosis,
                chronicDiseases: chronicDiseases,
                nafScore: document.getElementById('nafScore').value,
                weight: document.getElementById('weight').value,
                height: document.getElementById('height').value,
                albumin: document.getElementById('albumin').value || '',
                totalProtein: document.getElementById('totalProtein').value || '',
                followUpDate: document.getElementById('followUpDate').value || '',
                followUpResult: document.getElementById('followUpResult').value || '',
                followUpDetails: document.getElementById('followUpDetails').value || ''
            };

            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const isEdit = formData.action === 'update';
                    showAlert(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
                    resetForm();
                    await loadAllData();
                    setTimeout(() => document.querySelectorAll('.nav-tab')[3].click(), 1500);
                } else {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'), 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            } finally {
                showLoading(false);
            }
        });

        function resetForm() {
            document.getElementById('patientForm').reset();
            document.getElementById('editRowNumber').value = '';
            document.getElementById('otherDiagnosisGroup').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('cancelBtn').style.display = 'none';
            calculateResults();
            setDefaultDate();
        }

        function editPatient(rowNumber) {
            const patient = patients.find(p => p.rowNumber == rowNumber);
            if (!patient) return;

            document.getElementById('editRowNumber').value = patient.rowNumber;
            document.getElementById('recordDate').value = patient.recordDate || '';
            document.getElementById('hn').value = patient.hn || '';
            document.getElementById('firstName').value = patient.firstName || '';
            document.getElementById('lastName').value = patient.lastName || '';
            document.getElementById('ward').value = patient.ward || '';
            
            const standardDiagnoses = [
                'Stroke', "Parkinson's Disease", "Alzheimer's Disease", 'Epilepsy', 
                'Multiple Sclerosis', 'Brain Tumor', 'Meningitis', 'Encephalitis', 'Migraine',
                'Meningioma', 'Spinal stenosis', 'Spine tumors', 'Spondylolisthesis',
                'Cerebral aneurysm', 'Basal Ganglia Hemorrhage', 'Intracerebral Hemorrhage',
                'Intraventricular Hemorrhage', 'Subarachnoid Hemorrhage', 'Subdural Hematoma',
                'Failed Back Surgery'
            ];
            
            if (standardDiagnoses.includes(patient.diagnosis)) {
                document.getElementById('diagnosis').value = patient.diagnosis;
            } else {
                document.getElementById('diagnosis').value = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                document.getElementById('otherDiagnosis').value = patient.diagnosis;
                toggleOtherDiagnosis();
            }

            setChronicDiseases(patient.chronicDiseases);
            document.getElementById('nafScore').value = patient.nafScore || '';
            document.getElementById('weight').value = patient.weight || '';
            document.getElementById('height').value = patient.height || '';
            document.getElementById('albumin').value = patient.albumin || '';
            document.getElementById('totalProtein').value = patient.totalProtein || '';
            document.getElementById('followUpDate').value = patient.followUpDate || '';
            document.getElementById('followUpResult').value = patient.followUpResult || '';
            document.getElementById('followUpDetails').value = patient.followUpDetails || '';

            calculateResults();
            
            document.getElementById('submitBtn').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            document.querySelectorAll('.nav-tab')[1].click(); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ form
        }

        function deletePatient(rowNumber) {
            const patient = patients.find(p => p.rowNumber == rowNumber);
            if (!patient) return;

            deleteRowNumber = rowNumber;
            document.getElementById('deletePatientName').textContent = 
                `${patient.firstName} ${patient.lastName} (HN: ${patient.hn})`;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteRowNumber = null;
        }

        async function confirmDelete() {
            if (!deleteRowNumber) return;

            showLoading(true);
            closeDeleteModal();

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'delete',
                        rowNumber: deleteRowNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üóëÔ∏è', 'success');
                    await loadAllData();
                } else {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            } finally {
                showLoading(false);
            }
        }

        function renderTable() {
            const container = document.getElementById('tableContainer');
            
            // Sort data if sort column is set
            let dataToDisplay = [...searchFilteredPatients];
            if (sortColumn) {
                dataToDisplay.sort((a, b) => {
                    let aVal = a[sortColumn];
                    let bVal = b[sortColumn];
                    
                    // Handle NAF score as number
                    if (sortColumn === 'nafScore') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }
                    // Handle dates
                    else if (sortColumn === 'recordDate') {
                        aVal = new Date(aVal || '1900-01-01');
                        bVal = new Date(bVal || '1900-01-01');
                    }
                    // Handle strings
                    else {
                        aVal = String(aVal || '').toLowerCase();
                        bVal = String(bVal || '').toLowerCase();
                    }
                    
                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            // Calculate pagination
            const totalItems = dataToDisplay.length;
            totalPages = pageSize === 'all' ? 1 : Math.ceil(totalItems / parseInt(pageSize));
            
            // Ensure current page is valid
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }
            
            // Get items for current page
            let paginatedData;
            if (pageSize === 'all') {
                paginatedData = dataToDisplay;
            } else {
                const startIndex = (currentPage - 1) * parseInt(pageSize);
                const endIndex = startIndex + parseInt(pageSize);
                paginatedData = dataToDisplay.slice(startIndex, endIndex);
            }
            
            if (dataToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('recordDate')" style="min-width: 120px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th class="sortable" onclick="sortTable('hn')" style="min-width: 90px;">HN</th>
                            <th class="sortable" onclick="sortTable('firstName')" style="min-width: 150px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th class="sortable" onclick="sortTable('ward')" style="min-width: 100px;">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                            <th class="sortable" onclick="sortTable('diagnosis')" style="min-width: 150px;">‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å</th>
                            <th class="sortable" onclick="sortTable('nafScore')" style="min-width: 70px;">NAF</th>
                            <th style="min-width: 70px;">BMI</th>
                            <th style="min-width: 80px;">Albumin</th>
                            <th style="min-width: 120px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th>
                            <th style="min-width: 110px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            paginatedData.forEach(patient => {
                const bmi = patient.weight && patient.height ? 
                    (patient.weight / Math.pow(patient.height / 100, 2)).toFixed(2) : '-';
                const fullName = `${patient.firstName || ''} ${patient.lastName || ''}`.trim();
                const recordDate = patient.recordDate ? new Date(patient.recordDate).toLocaleDateString('th-TH') : '-';
                
                let displayNafScore = '-';
                if (patient.nafScore !== null && 
                    patient.nafScore !== undefined && 
                    patient.nafScore !== '-') {
                    const nafNum = Number(patient.nafScore);
                    if (!isNaN(nafNum)) {
                        displayNafScore = nafNum;
                    }
                }
                
                const nafScore = Number(patient.nafScore);
                let statusBadge = '';
                let followUpBadge = '';

                if (!isNaN(nafScore)) {
                    if (nafScore >= 11) {
                        statusBadge = `
                            <span class="status-badge" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); 
                                         color: white; 
                                         box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);">
                                üî¥ Severe (‚â•11)
                            </span>
                        `;
                    } else if (nafScore >= 6) {
                        statusBadge = `
                            <span class="status-badge" style="background: linear-gradient(135deg, #ffd93d 0%, #f9ca24 100%); 
                                         color: #333; 
                                         box-shadow: 0 2px 8px rgba(255, 217, 61, 0.3);">
                                üü° Moderate (6-10)
                            </span>
                        `;
                    } else {
                        statusBadge = `
                            <span class="status-badge" style="background: linear-gradient(135deg, #a8e6cf 0%, #81c784 100%); 
                                         color: #fff; 
                                         box-shadow: 0 2px 8px rgba(168, 230, 207, 0.3);">
                                üü¢ ‡∏ï‡πà‡∏≥ (<6)
                            </span>
                        `;
                    }
                } else {
                    statusBadge = `
                        <span style="background: #e0e0e0; 
                                     color: #666; 
                                     padding: 6px 12px; 
                                     border-radius: 20px; 
                                     font-size: 13px;">
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </span>
                    `;
                }
                
                if (patient.followUpResult && patient.followUpResult !== '') {
                    followUpBadge = `
                        <div class="status-followed">
                            ‚úì ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß
                        </div>
                    `;
                }
                
                html += `
                    <tr>
                        <td>${recordDate}</td>
                        <td>${patient.hn || '-'}</td>
                        <td>${fullName}</td>
                        <td>${patient.ward || '-'}</td>
                        <td>${patient.diagnosis || '-'}</td>
                        <td style="text-align: center; font-weight: bold;">${displayNafScore}</td>
                        <td>${bmi}</td>
                        <td>${patient.albumin || '-'}</td>
                        <td style="text-align: center;">
                            ${statusBadge}
                            ${followUpBadge}
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-warning" onclick="editPatient(${patient.rowNumber})" style="padding: 5px 10px; margin: 2px;">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deletePatient(${patient.rowNumber})" style="padding: 5px 10px; margin: 2px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
            
            // Update sort indicators
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            if (sortColumn) {
                const sortableHeaders = {
                    'recordDate': 0,
                    'hn': 1,
                    'firstName': 2,
                    'ward': 3,
                    'diagnosis': 4,
                    'nafScore': 5
                };
                const headerIndex = sortableHeaders[sortColumn];
                if (headerIndex !== undefined) {
                    const header = document.querySelectorAll('th.sortable')[headerIndex];
                    if (header) {
                        header.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
            }
            
            // Render pagination controls
            renderPagination(totalItems);
        }
function sortTable(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderTable();
        }
        
        function renderPagination(totalItems) {
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationControls = document.getElementById('paginationControls');
            
            if (pageSize === 'all') {
                paginationContainer.style.display = 'flex';
                paginationInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                paginationControls.innerHTML = '';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            const startItem = (currentPage - 1) * parseInt(pageSize) + 1;
            const endItem = Math.min(currentPage * parseInt(pageSize), totalItems);
            
            paginationInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á ${startItem}-${endItem} ‡∏à‡∏≤‡∏Å ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            
            let controlsHTML = '';
            
            // Previous button
            controlsHTML += `
                <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    ‚óÑ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                </button>
            `;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page
            if (startPage > 1) {
                controlsHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    controlsHTML += `<span class="pagination-dots">...</span>`;
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                controlsHTML += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    controlsHTML += `<span class="pagination-dots">...</span>`;
                }
                controlsHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            controlsHTML += `
                <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∫
                </button>
            `;
            
            paginationControls.innerHTML = controlsHTML;
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
        }
        
        function changePageSize() {
            pageSize = document.getElementById('pageSize').value;
            currentPage = 1; // Reset to first page
            renderTable();
        }

        function updateDashboard() {
            const total = filteredPatients.length;
            
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°: NAF >= 6
const needFollowUp = filteredPatients.filter(p => {
    const nafScore = parseFloat(p.nafScore);
    return nafScore >= 6;
}).length;
            
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å follow up)
            const followedUp = filteredPatients.filter(p => 
                p.followUpDate && p.followUpResult && p.followUpResult !== ''
            ).length;

            document.getElementById('totalPatients').textContent = total;
            document.getElementById('needFollowUp').textContent = needFollowUp;
            document.getElementById('followedUp').textContent = followedUp;

            renderTop5Diagnosis();
            renderTop5Chronic();
            renderCharts();
        }

        function renderTop5Diagnosis() {
            const diagnosisCounts = {};
            filteredPatients.forEach(p => {
                if (p.diagnosis) {
                    diagnosisCounts[p.diagnosis] = (diagnosisCounts[p.diagnosis] || 0) + 1;
                }
            });

            const sorted = Object.entries(diagnosisCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('top5Diagnosis');
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            let html = '';
            sorted.forEach(([diagnosis, count], index) => {
                html += `
                    <div class="top5-item">
                        <span class="top5-rank">#${index + 1}</span>
                        <span class="top5-name">${diagnosis}</span>
                        <span class="top5-count">${count}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderTop5Chronic() {
            const chronicCounts = {};
            filteredPatients.forEach(p => {
                if (p.chronicDiseases) {
                    const diseases = p.chronicDiseases.split(',').map(d => d.trim()).filter(d => d);
                    diseases.forEach(disease => {
                        chronicCounts[disease] = (chronicCounts[disease] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(chronicCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('top5Chronic');
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            let html = '';
            sorted.forEach(([disease, count], index) => {
                html += `
                    <div class="top5-item">
                        <span class="top5-rank">#${index + 1}</span>
                        <span class="top5-name">${disease}</span>
                        <span class="top5-count">${count}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function updateChartDisplay() {
            currentChartType = document.getElementById('chartType').value;
            currentComparisonType = document.getElementById('comparisonType').value;
            renderCharts();
        }

        function renderCharts() {
            const container = document.getElementById('chartsContainer');
            
            if (currentComparisonType !== 'none') {
                renderComparisonCharts();
                return;
            }
            
            // ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° NAF ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà (‡∏ô‡∏±‡∏ö 0 ‡∏î‡πâ‡∏ß‡∏¢)
// ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° NAF (‡∏ô‡∏±‡∏ö 0 ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≥)
const nafGroups = { '‡∏ï‡πà‡∏≥ (<6)': 0, 'Moderate (6-10)': 0, 'Severe (‚â•11)': 0 };
filteredPatients.forEach(p => {
    const score = parseFloat(p.nafScore);
    
    // ‡∏ô‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤ ‡∏£‡∏ß‡∏° NaN ‡πÅ‡∏•‡∏∞ 0
    if (isNaN(score) || score < 6) {
        nafGroups['‡∏ï‡πà‡∏≥ (<6)']++;
    } else if (score >= 11) {
        nafGroups['Severe (‚â•11)']++;
    } else {
        nafGroups['Moderate (6-10)']++;
    }
});
            const wardGroups = {};
            filteredPatients.forEach(p => {
                if (p.ward) {
                    wardGroups[p.ward] = (wardGroups[p.ward] || 0) + 1;
                }
            });

            const bmiGroups = { '‡∏ú‡∏≠‡∏°': 0, '‡∏õ‡∏Å‡∏ï‡∏¥': 0, '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô': 0, '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô': 0 };
            filteredPatients.forEach(p => {
                if (p.weight && p.height) {
                    const bmi = p.weight / Math.pow(p.height / 100, 2);
                    if (bmi < 18.5) bmiGroups['‡∏ú‡∏≠‡∏°']++;
                    else if (bmi < 23) bmiGroups['‡∏õ‡∏Å‡∏ï‡∏¥']++;
                    else if (bmi < 25) bmiGroups['‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô']++;
                    else bmiGroups['‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô']++;
                }
            });

            const albuminGroups = { '‡∏õ‡∏Å‡∏ï‡∏¥ (‚â•3.5)': 0, '‡∏ï‡πà‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (3.0-3.4)': 0, '‡∏ï‡πà‡∏≥ (<3.0)': 0, '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': 0 };
            filteredPatients.forEach(p => {
                const alb = parseFloat(p.albumin);
                if (!alb) albuminGroups['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']++;
                else if (alb >= 3.5) albuminGroups['‡∏õ‡∏Å‡∏ï‡∏¥ (‚â•3.5)']++;
                else if (alb >= 3.0) albuminGroups['‡∏ï‡πà‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (3.0-3.4)']++;
                else albuminGroups['‡∏ï‡πà‡∏≥ (<3.0)']++;
            });

            const proteinGroups = { '‡∏õ‡∏Å‡∏ï‡∏¥ (6.0-8.3)': 0, '‡∏ï‡πà‡∏≥ (<6.0)': 0, '‡∏™‡∏π‡∏á (>8.3)': 0, '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': 0 };
            filteredPatients.forEach(p => {
                const tp = parseFloat(p.totalProtein);
                if (!tp) proteinGroups['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']++;
                else if (tp >= 6.0 && tp <= 8.3) proteinGroups['‡∏õ‡∏Å‡∏ï‡∏¥ (6.0-8.3)']++;
                else if (tp < 6.0) proteinGroups['‡∏ï‡πà‡∏≥ (<6.0)']++;
                else proteinGroups['‡∏™‡∏π‡∏á (>8.3)']++;
            });

            const charts = [
                { title: '‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (NAF Score)', data: nafGroups, colors: ['#A8E6CF', '#FFD93D', '#FF6B6B'], id: 'nafChart' },
                { title: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏≠', data: wardGroups, colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'], id: 'wardChart' },
                { title: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤ BMI', data: bmiGroups, colors: ['#A8E6CF', '#FFD93D', '#FFB347', '#FF6B6B'], id: 'bmiChart' },
                { title: '‡∏Ñ‡πà‡∏≤ Albumin', data: albuminGroups, colors: ['#6BCF7F', '#FFE66D', '#FF6B9D', '#C7CEEA'], id: 'albuminChart' },
                { title: '‡∏Ñ‡πà‡∏≤ Total Protein', data: proteinGroups, colors: ['#4ECDC4', '#45B7D1', '#FEA47F', '#D4D4D4'], id: 'proteinChart' }
            ];

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">';
            
            charts.forEach(chart => {
                html += `
                    <div class="chart-container">
                        <h3>
                            <span>${chart.title}</span>
                            <button class="download-btn" onclick="downloadChart('${chart.id}', '${chart.title}')">
                                üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                            </button>
                        </h3>
                        <div class="chart-wrapper">
                            <canvas id="${chart.id}" width="350" height="350"></canvas>
                            <div id="${chart.id}_legend" style="margin-top: 20px; width: 100%;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;

            setTimeout(() => {
                charts.forEach(chart => {
                    if (currentChartType === 'bar') {
                        drawBarChart(chart.id, chart.data, chart.colors);
                    } else if (currentChartType === 'donut') {
                        drawDonutChart(chart.id, chart.data, chart.colors);
                    } else {
                        drawPieChart(chart.id, chart.data, chart.colors);
                    }
                });
            }, 100);
        }

        function drawPieChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 20;
            const radius = 120;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            
            if (total === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', centerX, centerY);
                return;
            }
            
            const entries = Object.entries(data).filter(([_, value]) => value > 0);
            let currentAngle = -Math.PI / 2;
            
            const segments = [];
            
            // ‡∏ß‡∏≤‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            entries.forEach(([label, value], index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                const color = colors[index % colors.length];
                
                // ‡∏ß‡∏≤‡∏î slice ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏á‡∏≤
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤
                ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                ctx.fillStyle = color;
                ctx.fill();
                
                // ‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.restore();
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                const middleAngle = currentAngle + sliceAngle / 2;
                const textX = centerX + (radius * 0.7) * Math.cos(middleAngle);
                const textY = centerY + (radius * 0.7) * Math.sin(middleAngle);
                
                // ‡∏ß‡∏≤‡∏î‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
                const percentage = ((value / total) * 100).toFixed(1);
                if (percentage > 5) { // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5%
                    ctx.save();
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 3;
                    ctx.fillText(`${percentage}%`, textX, textY);
                    ctx.restore();
                }
                
                segments.push({
                    label,
                    value,
                    percentage,
                    color
                });
                
                currentAngle += sliceAngle;
            });
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Legend
            const legendDiv = document.getElementById(`${canvasId}_legend`);
            let legendHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            segments.forEach(segment => {
                legendHTML += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border-radius: 5px; border-left: 4px solid ${segment.color};">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <div style="width: 16px; height: 16px; background: ${segment.color}; border-radius: 3px; flex-shrink: 0;"></div>
                            <span style="font-size: 14px;"><strong>${segment.label}</strong></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #667eea; font-weight: bold; font-size: 16px;">${segment.value}</span>
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                ${segment.percentage}%
                            </span>
                        </div>
                    </div>
                `;
            });
            
            legendHTML += '</div>';
            legendDiv.innerHTML = legendHTML;
        }

        function downloadChart(canvasId, title) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á canvas ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            const downloadCanvas = document.createElement('canvas');
            downloadCanvas.width = canvas.width;
            downloadCanvas.height = canvas.height;
            const ctx = downloadCanvas.getContext('2d');
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, downloadCanvas.width, downloadCanvas.height);
            
            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡∏á‡πÑ‡∏õ
            ctx.drawImage(canvas, 0, 0);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≤‡∏ü
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, downloadCanvas.width / 2, 30);
            
            // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            const link = document.createElement('a');
            link.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = downloadCanvas.toDataURL('image/png');
            link.click();
            
            showAlert(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü "${title}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ`, 'success');
        }
function drawDonutChart(canvasId, data, colors) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2 - 20;
    const outerRadius = 120;
    const innerRadius = 70;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const total = Object.values(data).reduce((sum, val) => sum + val, 0);
    
    if (total === 0) {
        ctx.font = '16px Arial';
        ctx.fillStyle = '#999';
        ctx.textAlign = 'center';
        ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', centerX, centerY);
        return;
    }
    
    const entries = Object.entries(data).filter(([_, value]) => value > 0);
    let currentAngle = -Math.PI / 2;
    const segments = [];
    
    entries.forEach(([label, value], index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        const color = colors[index % colors.length];
        
        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, outerRadius, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();
        
        ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        ctx.fillStyle = color;
        ctx.fill();
        
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
        
        const percentage = ((value / total) * 100).toFixed(1);
        segments.push({ label, value, percentage, color });
        currentAngle += sliceAngle;
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
    ctx.save();
    ctx.fillStyle = '#667eea';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(total, centerX, centerY - 10);
    ctx.font = '14px Arial';
    ctx.fillStyle = '#666';
    ctx.fillText('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', centerX, centerY + 15);
    ctx.restore();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Legend
    const legendDiv = document.getElementById(`${canvasId}_legend`);
    let legendHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
    
    segments.forEach(segment => {
        legendHTML += `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border-radius: 5px; border-left: 4px solid ${segment.color};">
                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <div style="width: 16px; height: 16px; background: ${segment.color}; border-radius: 3px;"></div>
                    <span style="font-size: 14px;"><strong>${segment.label}</strong></span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #667eea; font-weight: bold; font-size: 16px;">${segment.value}</span>
                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                        ${segment.percentage}%
                    </span>
                </div>
            </div>
        `;
    });
    
    legendHTML += '</div>';
    legendDiv.innerHTML = legendHTML;
}

function drawBarChart(canvasId, data, colors) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const entries = Object.entries(data).filter(([_, value]) => value > 0);
    if (entries.length === 0) {
        ctx.font = '16px Arial';
        ctx.fillStyle = '#999';
        ctx.textAlign = 'center';
        ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    const maxValue = Math.max(...entries.map(([_, v]) => v));
    const padding = 60;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;
    const barWidth = chartWidth / entries.length * 0.7;
    const barSpacing = chartWidth / entries.length;
    
    entries.forEach(([label, value], index) => {
        const barHeight = (value / maxValue) * chartHeight;
        const x = padding + index * barSpacing + (barSpacing - barWidth) / 2;
        const y = canvas.height - padding - barHeight;
        
        const color = colors[index % colors.length];
        
        ctx.save();
        ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
        ctx.shadowBlur = 5;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        ctx.fillStyle = color;
        ctx.fillRect(x, y, barWidth, barHeight);
        ctx.restore();
        
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, barWidth, barHeight);
        
        ctx.fillStyle = '#333';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(value, x + barWidth / 2, y - 10);
        
        ctx.save();
        ctx.translate(x + barWidth / 2, canvas.height - padding + 20);
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label, 0, 0);
        ctx.restore();
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Legend
    const segments = entries.map(([label, value], index) => ({
        label,
        value,
        percentage: ((value / entries.reduce((sum, [_, v]) => sum + v, 0)) * 100).toFixed(1),
        color: colors[index % colors.length]
    }));
    
    const legendDiv = document.getElementById(`${canvasId}_legend`);
    let legendHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
    
    segments.forEach(segment => {
        legendHTML += `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border-radius: 5px; border-left: 4px solid ${segment.color};">
                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <div style="width: 16px; height: 16px; background: ${segment.color}; border-radius: 3px;"></div>
                    <span style="font-size: 14px;"><strong>${segment.label}</strong></span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #667eea; font-weight: bold; font-size: 16px;">${segment.value}</span>
                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                        ${segment.percentage}%
                    </span>
                </div>
            </div>
        `;
    });
    
    legendHTML += '</div>';
    legendDiv.innerHTML = legendHTML;
}

function renderComparisonCharts() {
    if (currentComparisonType === 'monthly') {
        renderMonthlyComparison();
    } else if (currentComparisonType === 'yearly') {
        renderYearlyComparison();
    }
}

function renderMonthlyComparison() {
    const monthlyData = {};
    
    filteredPatients.forEach(p => {
        if (!p.recordDate) return;
        const date = new Date(p.recordDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { 
                '‡∏ï‡πà‡∏≥ (<6)': 0, 
                'Moderate (6-10)': 0, 
                'Severe (‚â•11)': 0,
                total: 0
            };
        }
        
        const nafScore = parseFloat(p.nafScore);
        if (isNaN(nafScore) || nafScore < 6) {
            monthlyData[monthKey]['‡∏ï‡πà‡∏≥ (<6)']++;
        } else if (nafScore >= 11) {
            monthlyData[monthKey]['Severe (‚â•11)']++;
        } else {
            monthlyData[monthKey]['Moderate (6-10)']++;
        }
        monthlyData[monthKey].total++;
    });

    const sortedMonths = Object.keys(monthlyData).sort().slice(-12);
    const labels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        const monthNames = ['', '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
        return `${monthNames[parseInt(month)]} ${parseInt(year) + 543}`;
    });

    renderComparisonView(sortedMonths, labels, monthlyData, '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
}
function renderYearlyComparison() {
    const yearlyData = {};
    
    filteredPatients.forEach(p => {
        if (!p.recordDate) return;
        const year = new Date(p.recordDate).getFullYear();
        
        if (!yearlyData[year]) {
            yearlyData[year] = { 
                '‡∏ï‡πà‡∏≥ (<6)': 0, 
                'Moderate (6-10)': 0, 
                'Severe (‚â•11)': 0,
                total: 0
            };
        }
        
        const nafScore = parseFloat(p.nafScore);
        if (nafScore >= 11) yearlyData[year]['Severe (‚â•11)']++;
        else if (nafScore >= 6) yearlyData[year]['Moderate (6-10)']++;
        else if (nafScore >= 0) yearlyData[year]['‡∏ï‡πà‡∏≥ (<6)']++;
        
        yearlyData[year].total++;
    });

    const sortedYears = Object.keys(yearlyData).sort();
    const labels = sortedYears.map(y => `‡∏õ‡∏µ ${parseInt(y) + 543}`);

    renderComparisonView(sortedYears, labels, yearlyData, '‡∏£‡∏≤‡∏¢‡∏õ‡∏µ');
}

function renderComparisonView(periods, labels, data, periodType) {
    const container = document.getElementById('chartsContainer');
    
    let html = `
        <h3 style="margin-bottom: 20px; color: #667eea;">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${periodType}</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="chart-container">
                <h3>
                    <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</span>
                    <button class="download-btn" onclick="downloadChart('compChart1', '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö${periodType}_‡∏Å‡∏£‡∏≤‡∏ü1')">
                        üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    </button>
                </h3>
                <canvas id="compChart1" width="500" height="350"></canvas>
            </div>
            <div class="chart-container">
                <h3>
                    <span>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    <button class="download-btn" onclick="downloadChart('compChart2', '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°${periodType}_‡∏Å‡∏£‡∏≤‡∏ü2')">
                        üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    </button>
                </h3>
                <canvas id="compChart2" width="500" height="350"></canvas>
            </div>
        </div>
    `;
    
    container.innerHTML = html;

    setTimeout(() => {
        drawComparisonBarChart('compChart1', periods, labels, data);
        drawComparisonLineChart('compChart2', periods, labels, data);
    }, 100);
}

function drawComparisonBarChart(canvasId, periods, labels, data) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const padding = 60;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;
    
    const categories = ['‡∏ï‡πà‡∏≥ (<6)', 'Moderate (6-10)', 'Severe (‚â•11)'];
    const colors = ['#A8E6CF', '#FFD93D', '#FF6B6B'];
    
    let maxValue = 0;
    periods.forEach(period => {
        const total = categories.reduce((sum, cat) => sum + data[period][cat], 0);
        if (total > maxValue) maxValue = total;
    });
    
    if (maxValue === 0) {
        ctx.font = '16px Arial';
        ctx.fillStyle = '#999';
        ctx.textAlign = 'center';
        ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    const barGroupWidth = chartWidth / periods.length * 0.8;
    const barWidth = barGroupWidth / categories.length;
    const groupSpacing = chartWidth / periods.length;
    
    periods.forEach((period, pIndex) => {
        categories.forEach((category, cIndex) => {
            const value = data[period][category];
            const barHeight = (value / maxValue) * chartHeight;
            const x = padding + pIndex * groupSpacing + cIndex * barWidth;
            const y = canvas.height - padding - barHeight;
            
            ctx.fillStyle = colors[cIndex];
            ctx.fillRect(x, y, barWidth * 0.9, barHeight);
            
            if (value > 0) {
                ctx.fillStyle = '#333';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x + barWidth * 0.45, y - 5);
            }
        });
        
        ctx.fillStyle = '#333';
        ctx.font = '11px Arial';
        ctx.textAlign = 'center';
        const labelText = labels[pIndex];
        ctx.fillText(labelText, padding + pIndex * groupSpacing + barGroupWidth / 2, canvas.height - padding + 25);
    });
    
    // ‡∏ß‡∏≤‡∏î Legend
    categories.forEach((category, index) => {
        const y = 20 + index * 22;
        ctx.fillStyle = colors[index];
        ctx.fillRect(10, y, 15, 15);
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(category, 30, y + 12);
    });
}

function drawComparisonLineChart(canvasId, periods, labels, data) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const padding = 60;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;
    
    const totals = periods.map(period => data[period].total);
    const maxValue = Math.max(...totals);
    
    if (maxValue === 0) {
        ctx.font = '16px Arial';
        ctx.fillStyle = '#999';
        ctx.textAlign = 'center';
        ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏¥‡∏î
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 5; i++) {
        const y = canvas.height - padding - (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(canvas.width - padding, y);
        ctx.stroke();
        
        ctx.fillStyle = '#666';
        ctx.font = '11px Arial';
        ctx.textAlign = 'right';
        ctx.fillText(Math.round((maxValue / 5) * i), padding - 10, y + 4);
    }
    
    // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
    ctx.strokeStyle = '#667eea';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    const pointSpacing = periods.length > 1 ? chartWidth / (periods.length - 1) : 0;
    
    periods.forEach((period, index) => {
        const x = padding + (pointSpacing * index);
        const y = canvas.height - padding - (totals[index] / maxValue) * chartHeight;
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();
    
    // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤
    periods.forEach((period, index) => {
        const x = padding + (pointSpacing * index);
        const y = canvas.height - padding - (totals[index] / maxValue) * chartHeight;
        
        ctx.fillStyle = '#667eea';
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#333';
        ctx.font = 'bold 13px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(totals[index], x, y - 15);
        
        ctx.font = '11px Arial';
        ctx.fillText(labels[index], x, canvas.height - padding + 25);
    });
}
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 
                               type === 'warning' ? 'alert-warning' : 
                               type === 'info' ? 'alert-info' : 'alert-danger';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
