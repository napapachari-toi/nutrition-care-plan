<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Nutrition Care Plan - Complete Version</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { font-size: 1.1em; opacity: 0.9; }
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }
        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .nav-tab:hover { background: #e9ecef; }
        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }
        .content { padding: 30px; }
        .page { display: none; }
        .page.active { display: block; }
        .welcome-section { text-align: center; padding: 60px 20px; }
        .welcome-section h2 { font-size: 2em; color: #333; margin-bottom: 20px; }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea { min-height: 80px; resize: vertical; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item { display: flex; align-items: center; }
        .checkbox-item input[type="checkbox"] { width: auto; margin-right: 8px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 3em; font-weight: bold; margin-bottom: 10px; }
        .stat-label { font-size: 1.1em; opacity: 0.9; }
        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
        }
        .chart-container h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .chart-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        canvas { max-width: 100%; height: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #667eea; color: white; font-weight: bold; }
        tr:hover { background: #f8f9fa; }
        .result-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .result-label { font-weight: bold; color: #495057; }
        .result-value { color: #667eea; font-weight: bold; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header { font-size: 1.5em; margin-bottom: 20px; color: #333; }
        .action-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .top5-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .top5-card { background: #f8f9fa; padding: 20px; border-radius: 10px; }
        .top5-card h3 { color: #667eea; margin-bottom: 15px; }
        .top5-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .top5-rank { font-weight: bold; color: #667eea; margin-right: 10px; }
        .top5-name { flex: 1; }
        .top5-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner { background: white; padding: 30px; border-radius: 10px; text-align: center; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .filter-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-group label { margin: 0; font-weight: bold; color: #667eea; }
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            min-width: 120px;
        }
        .filter-group select:focus,
        .filter-group input:focus { border-color: #667eea; outline: none; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
        }
        .status-followed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        @media (max-width: 768px) {
            .filter-row { flex-direction: column; align-items: stretch; }
            .filter-group { width: 100%; }
            .filter-group select, .filter-group input { width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .top5-container { grid-template-columns: 1fr; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
            .btn { padding: 8px 15px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üè• Nutrition Care Plan</h1>
            <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('home')">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            <button class="nav-tab" onclick="showPage('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showPage('table')">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <div class="content">
            <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
            <div id="home" class="page active">
                <div class="welcome-section">
                    <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Nutrition Care Plan</h2>
                    <p style="color: #666; margin-bottom: 30px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û<br>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ö‡∏ö Interactive ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p>
                    <button class="btn btn-success" onclick="loadAllData()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="page">
                <h2 style="margin-bottom: 20px;">üìä Dashboard - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>üóìÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:</label>
                            <select id="dashboardStartMonth">
                                <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="dashboardStartYear"><option value="">‡∏õ‡∏µ</option></select>
                        </div>
                        <span style="margin: 0 5px;">‡∏ñ‡∏∂‡∏á</span>
                        <div class="filter-group">
                            <select id="dashboardEndMonth">
                                <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="01">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="02">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="03">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="04">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="08">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="09">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="dashboardEndYear"><option value="">‡∏õ‡∏µ</option></select>
                        </div>
                        <button class="btn btn-primary" onclick="applyDashboardFilter()">üîç ‡∏Å‡∏£‡∏≠‡∏á</button>
                        <button class="btn btn-secondary" onclick="clearDashboardFilter()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    </div>
                    <div id="dashboardFilterInfo" style="margin-top: 10px; color: #667eea; font-weight: bold;"></div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPatients">-</div>
                        <div class="stat-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="needFollowUp">-</div>
                        <div class="stat-label">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="followedUp">-</div>
                        <div class="stat-label">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                </div>

                <!-- ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>üìä ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü:</label>
                            <select id="chartType" onchange="updateCharts()">
                                <option value="pie">ü•ß ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (Pie)</option>
                                <option value="donut">üç© ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó (Donut)</option>
                                <option value="bar">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>üìÖ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:</label>
                            <select id="comparisonType" onchange="updateCharts()">
                                <option value="none">‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option>
                                <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="chartsContainer"></div>
            </div>

            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div id="table" class="page">
                <h2 style="margin-bottom: 20px;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
                <div class="filter-section" style="margin-bottom: 15px;">
                    <div class="filter-row">
                        <div class="filter-group" style="flex: 1; max-width: 400px;">
                            <label>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label>
                            <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" 
                                   style="width: 100%;" oninput="applySearch()">
                        </div>
                        <button class="btn btn-secondary" onclick="clearSearch()">üîÑ ‡∏•‡πâ‡∏≤‡∏á</button>
                    </div>
                    <div id="searchInfo" style="margin-top: 10px; color: #667eea; font-weight: bold;"></div>
                </div>
                
                <div id="tableContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà URL ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyT63XP7ugf7QovhgCLtfA3QWLeEr06ibZAlZKZQYtyDuCx1jjvP6xWIH0sQqR4xSps/exec';
        
        let patients = [];
        let filteredPatients = [];
        let searchFilteredPatients = [];

        window.onload = function() {
            populateYearOptions();
            loadAllData();
        };

        function populateYearOptions() {
            const currentYear = new Date().getFullYear();
            const yearSelects = ['dashboardStartYear', 'dashboardEndYear'];
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">‡∏õ‡∏µ</option>';
                for (let year = currentYear - 5; year <= currentYear + 2; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 543;
                    select.appendChild(option);
                }
            });
        }

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            if (pageId === 'dashboard') updateCharts();
            if (pageId === 'table') renderTable();
        }

        async function loadAllData() {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                if (data.status === 'success') {
                    patients = data.data;
                    filteredPatients = patients;
                    searchFilteredPatients = patients;
                    renderTable();
                    updateDashboard();
                    alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ');
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
            } finally {
                showLoading(false);
            }
        }

        function filterPatientsByDateRange(startMonth, startYear, endMonth, endYear) {
            if (!startMonth && !startYear && !endMonth && !endYear) return patients;
            return patients.filter(p => {
                if (!p.recordDate) return false;
                const recordDate = new Date(p.recordDate);
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth() + 1;
                const recordYearMonth = recordYear * 100 + recordMonth;
                let startYearMonth = null, endYearMonth = null;
                if (startYear && startMonth) {
                    startYearMonth = parseInt(startYear) * 100 + parseInt(startMonth);
                } else if (startYear) {
                    startYearMonth = parseInt(startYear) * 100 + 1;
                } else if (startMonth) {
                    startYearMonth = 0;
                }
                if (endYear && endMonth) {
                    endYearMonth = parseInt(endYear) * 100 + parseInt(endMonth);
                } else if (endYear) {
                    endYearMonth = parseInt(endYear) * 100 + 12;
                } else if (endMonth) {
                    endYearMonth = 999999;
                }
                if (startYearMonth !== null && endYearMonth !== null) {
                    return recordYearMonth >= startYearMonth && recordYearMonth <= endYearMonth;
                } else if (startYearMonth !== null) {
                    return recordYearMonth >= startYearMonth;
                } else if (endYearMonth !== null) {
                    return recordYearMonth <= endYearMonth;
                }
                return true;
            });
        }

        function applyDashboardFilter() {
            const startMonth = document.getElementById('dashboardStartMonth').value;
            const startYear = document.getElementById('dashboardStartYear').value;
            const endMonth = document.getElementById('dashboardEndMonth').value;
            const endYear = document.getElementById('dashboardEndYear').value;
            filteredPatients = filterPatientsByDateRange(startMonth, startYear, endMonth, endYear);
            updateDashboard();
            const infoDiv = document.getElementById('dashboardFilterInfo');
            if (startMonth || startYear || endMonth || endYear) {
                infoDiv.textContent = `üìä ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${filteredPatients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            } else {
                infoDiv.textContent = '';
            }
        }

        function clearDashboardFilter() {
            document.getElementById('dashboardStartMonth').value = '';
            document.getElementById('dashboardStartYear').value = '';
            document.getElementById('dashboardEndMonth').value = '';
            document.getElementById('dashboardEndYear').value = '';
            filteredPatients = patients;
            updateDashboard();
            document.getElementById('dashboardFilterInfo').textContent = '';
        }

        function applySearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!searchTerm) {
                searchFilteredPatients = filteredPatients;
                document.getElementById('searchInfo').textContent = '';
            } else {
                searchFilteredPatients = filteredPatients.filter(p => {
                    const hn = (p.hn || '').toLowerCase();
                    const firstName = (p.firstName || '').toLowerCase();
                    const lastName = (p.lastName || '').toLowerCase();
                    const fullName = `${firstName} ${lastName}`;
                    return hn.includes(searchTerm) || firstName.includes(searchTerm) || 
                           lastName.includes(searchTerm) || fullName.includes(searchTerm);
                });
                document.getElementById('searchInfo').textContent = 
                    `üîç ‡∏û‡∏ö ${searchFilteredPatients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${document.getElementById('searchInput').value}"`;
            }
            renderTable();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchFilteredPatients = filteredPatients;
            document.getElementById('searchInfo').textContent = '';
            renderTable();
        }

        function updateDashboard() {
            const total = filteredPatients.length;
            const needFollowUp = filteredPatients.filter(p => parseFloat(p.nafScore) >= 6).length;
            const followedUp = filteredPatients.filter(p => p.followUpDate && p.followUpResult && p.followUpResult !== '').length;
            document.getElementById('totalPatients').textContent = total;
            document.getElementById('needFollowUp').textContent = needFollowUp;
            document.getElementById('followedUp').textContent = follow
            edUp;
            updateCharts();
        }

        function renderTable() {
            const container = document.getElementById('tableContainer');
            if (searchFilteredPatients.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>HN</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏´‡∏≠</th>
                            <th>NAF</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            searchFilteredPatients.forEach(patient => {
                const fullName = `${patient.firstName || ''} ${patient.lastName || ''}`.trim();
                const recordDate = patient.recordDate ? new Date(patient.recordDate).toLocaleDateString('th-TH') : '-';
                const nafScore = parseFloat(patient.nafScore);
                let statusBadge = '';
                let followUpBadge = '';
                
                if (nafScore >= 11) {
                    statusBadge = `<span class="status-badge" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);">üî¥ Severe (‚â•11)</span>`;
                } else if (nafScore >= 6) {
                    statusBadge = `<span class="status-badge" style="background: linear-gradient(135deg, #ffd93d 0%, #f9ca24 100%); color: #333; box-shadow: 0 2px 8px rgba(255, 217, 61, 0.3);">üü° Moderate (6-10)</span>`;
                } else if (nafScore >= 0) {
                    statusBadge = `<span class="status-badge" style="background: linear-gradient(135deg, #a8e6cf 0%, #81c784 100%); color: #fff; box-shadow: 0 2px 8px rgba(168, 230, 207, 0.3);">üü¢ ‡∏ï‡πà‡∏≥ (<6)</span>`;
                }
                
                if (patient.followUpResult && patient.followUpResult !== '') {
                    followUpBadge = `<div class="status-followed">‚úì ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>`;
                }
                
                html += `
                    <tr>
                        <td>${recordDate}</td>
                        <td>${patient.hn || '-'}</td>
                        <td>${fullName}</td>
                        <td>${patient.ward || '-'}</td>
                        <td style="text-align: center; font-weight: bold;">${patient.nafScore || '-'}</td>
                        <td style="text-align: center;">${statusBadge}${followUpBadge}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏ü =====
        function updateCharts() {
            const chartType = document.getElementById('chartType').value;
            const comparisonType = document.getElementById('comparisonType').value;
            
            if (comparisonType === 'none') {
                renderNormalCharts(chartType);
            } else if (comparisonType === 'monthly') {
                renderMonthlyComparison(chartType);
            } else if (comparisonType === 'yearly') {
                renderYearlyComparison(chartType);
            }
        }

        function renderNormalCharts(chartType) {
            const container = document.getElementById('chartsContainer');
            
            const nafGroups = { '‡∏ï‡πà‡∏≥ (<6)': 0, 'Moderate (6-10)': 0, 'Severe (‚â•11)': 0 };
            filteredPatients.forEach(p => {
                const score = parseFloat(p.nafScore);
                if (score >= 11) nafGroups['Severe (‚â•11)']++;
                else if (score >= 6) nafGroups['Moderate (6-10)']++;
                else if (score >= 0) nafGroups['‡∏ï‡πà‡∏≥ (<6)']++;
            });

            const charts = [
                { title: 'NAF Score', data: nafGroups, colors: ['#A8E6CF', '#FFD93D', '#FF6B6B'], id: 'nafChart' }
            ];

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">';
            
            charts.forEach(chart => {
                html += `
                    <div class="chart-container">
                        <h3>
                            <span>${chart.title}</span>
                            <button class="download-btn" onclick="downloadChart('${chart.id}', '${chart.title}')">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
                        </h3>
                        <div class="chart-wrapper">
                            <canvas id="${chart.id}" width="350" height="350"></canvas>
                            <div id="${chart.id}_legend" style="margin-top: 20px; width: 100%;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;

            setTimeout(() => {
                charts.forEach(chart => {
                    if (chartType === 'bar') {
                        drawBarChart(chart.id, chart.data, chart.colors);
                    } else if (chartType === 'donut') {
                        drawDonutChart(chart.id, chart.data, chart.colors);
                    } else {
                        drawPieChart(chart.id, chart.data, chart.colors);
                    }
                });
            }, 100);
        }

        function renderMonthlyComparison(chartType) {
            const container = document.getElementById('chartsContainer');
            const monthlyData = {};
            
            filteredPatients.forEach(p => {
                if (!p.recordDate) return;
                const date = new Date(p.recordDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { '‡∏ï‡πà‡∏≥ (<6)': 0, 'Moderate (6-10)': 0, 'Severe (‚â•11)': 0 };
                }
                const score = parseFloat(p.nafScore);
                if (score >= 11) monthlyData[monthKey]['Severe (‚â•11)']++;
                else if (score >= 6) monthlyData[monthKey]['Moderate (6-10)']++;
                else if (score >= 0) monthlyData[monthKey]['‡∏ï‡πà‡∏≥ (<6)']++;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            
            let html = '<h3 style="color: #667eea; margin-bottom: 20px;">üìÖ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>';
            html += '<div class="comparison-grid">';
            
            sortedMonths.forEach((monthKey, index) => {
                const [year, month] = monthKey.split('-');
                const monthNames = ['', '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                const monthName = monthNames[parseInt(month)];
                const yearThai = parseInt(year) + 543;
                
                html += `
                    <div class="chart-container">
                        <h3>${monthName} ${yearThai}</h3>
                        <div class="chart-wrapper">
                            <canvas id="month_${index}" width="300" height="300"></canvas>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;

            setTimeout(() => {
                sortedMonths.forEach((monthKey, index) => {
                    const colors = ['#A8E6CF', '#FFD93D', '#FF6B6B'];
                    if (chartType === 'bar') {
                        drawBarChart(`month_${index}`, monthlyData[monthKey], colors);
                    } else if (chartType === 'donut') {
                        drawDonutChart(`month_${index}`, monthlyData[monthKey], colors);
                    } else {
                        drawPieChart(`month_${index}`, monthlyData[monthKey], colors);
                    }
                });
            }, 100);
        }

        function renderYearlyComparison(chartType) {
            const container = document.getElementById('chartsContainer');
            const yearlyData = {};
            
            filteredPatients.forEach(p => {
                if (!p.recordDate) return;
                const date = new Date(p.recordDate);
                const year = date.getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { '‡∏ï‡πà‡∏≥ (<6)': 0, 'Moderate (6-10)': 0, 'Severe (‚â•11)': 0 };
                }
                const score = parseFloat(p.nafScore);
                if (score >= 11) yearlyData[year]['Severe (‚â•11)']++;
                else if (score >= 6) yearlyData[year]['Moderate (6-10)']++;
                else if (score >= 0) yearlyData[year]['‡∏ï‡πà‡∏≥ (<6)']++;
            });

            const sortedYears = Object.keys(yearlyData).sort();
            
            let html = '<h3 style="color: #667eea; margin-bottom: 20px;">üìÜ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>';
            html += '<div class="comparison-grid">';
            
            sortedYears.forEach((year, index) => {
                const yearThai = parseInt(year) + 543;
                html += `
                    <div class="chart-container">
                        <h3>‡∏õ‡∏µ ${yearThai}</h3>
                        <div class="chart-wrapper">
                            <canvas id="year_${index}" width="300" height="300"></canvas>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;

            setTimeout(() => {
                sortedYears.forEach((year, index) => {
                    const colors = ['#A8E6CF', '#FFD93D', '#FF6B6B'];
                    if (chartType === 'bar') {
                        drawBarChart(`year_${index}`, yearlyData[year], colors);
                    } else if (chartType === 'donut') {
                        drawDonutChart(`year_${index}`, yearlyData[year], colors);
                    } else {
                        drawPieChart(`year_${index}`, yearlyData[year], colors);
                    }
                });
            }, 100);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Pie
        function drawPieChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 20;
            const radius = 120;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            if (total === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', centerX, centerY);
                return;
            }
            const entries = Object.entries(data).filter(([_, value]) => value > 0);
            let currentAngle = -Math.PI / 2;
            const segments = [];
            entries.forEach(([label, value], index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                const color = colors[index % colors.length];
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.restore();
                const middleAngle = currentAngle + sliceAngle / 2;
                const textX = centerX + (radius * 0.7) * Math.cos(middleAngle);
                const textY = centerY + (radius * 0.7) * Math.sin(middleAngle);
                const percentage = ((value / total) * 100).toFixed(1);
                if (percentage > 5) {
                    ctx.save();
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 3;
                    ctx.fillText(`${percentage}%`, textX, textY);
                    ctx.restore();
                }
                segments.push({ label, value, percentage, color });
                currentAngle += sliceAngle;
            });
            const legendDiv = document.getElementById(`${canvasId}_legend`);
            if (legendDiv) {
                let legendHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                segments.forEach(segment => {
                    legendHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border-radius: 5px; border-left: 4px solid ${segment.color};">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <div style="width: 16px; height: 16px; background: ${segment.color}; border-radius: 3px;"></div>
                                <span style="font-size: 14px;"><strong>${segment.label}</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #667eea; font-weight: bold; font-size: 16px;">${segment.value}</span>
                                <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${segment.percentage}%</span>
                            </div>
                        </div>
                    `;
                });
                legendHTML += '</div>';
                legendDiv.innerHTML = legendHTML;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Donut
        function drawDonutChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 20;
            const outerRadius = 120;
            const innerRadius = 70;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            if (total === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', centerX, centerY);
                return;
            }
            const entries = Object.entries(data).filter(([_, value]) => value > 0);
            let currentAngle = -Math.PI / 2;
            const segments = [];
            entries.forEach(([label, value], index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                const color = colors[index % colors.length];
                ctx.save();
                ctx.beginPath();
                ctx.arc(centerX, centerY, outerRadius, currentAngle, currentAngle + sliceAngle);
                ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
                ctx.closePath();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.restore();
                const percentage = ((value / total) * 100).toFixed(1);
                segments.push({ label, value, percentage, color });
                currentAngle += sliceAngle;
            });
            ctx.save();
            ctx.fillStyle = '#333';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(total, centerX, centerY - 10);
            ctx.font = '14px Arial';
            ctx.fillText('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', centerX, centerY + 15);
            ctx.restore();
            const legendDiv = document.getElementById(`${canvasId}_legend`);
            if (legendDiv) {
                let legendHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                segments.forEach(segment => {
                    legendHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border-radius: 5px; border-left: 4px solid ${segment.color};">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <div style="width: 16px; height: 16px; background: ${segment.color}; border-radius: 3px;"></div>
                                <span style="font-size: 14px;"><strong>${segment.label}</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #667eea; font-weight: bold; font-size: 16px;">${segment.value}</span>
                                <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${segment.percentage}%</span>
                            </div>
                        </div>
                    `;
                });
                legendHTML += '</div>';
                legendDiv.innerHTML = legendHTML;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü Bar
        function drawBarChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const entries = Object.entries(data).filter(([_, value]) => value > 0);
            if (entries.length === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', canvas.width / 2, canvas.height / 2);
                return;
            }
            const maxValue = Math.max(...entries.map(([_, val]) => val));
            const barWidth = (canvas.width - 80) / entries.length;
            const chartHeight = canvas.height - 100;
            entries.forEach(([label, value], index) => {
                const barHeight = (value / maxValue) * chartHeight;
                const x = 40 + index * barWidth + 10;
                const y = canvas.height - 50 - barHeight;
                const color = colors[index % colors.length];
                const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                gradient.addColorStop(0, color);
                gradient.addColorStop(1, color + '99');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth - 20, barHeight);
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, barWidth - 20, barHeight);
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x + (barWidth - 20) / 2, y - 10);
                ctx.font = '12px Arial';
                ctx.save();
                ctx.translate(x + (barWidth - 20) / 2, canvas.height - 30);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(label, 0, 0);
                ctx.restore();
            });
        }

        function downloadChart(canvasId, title) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const downloadCanvas = document.createElement('canvas');
            downloadCanvas.width = canvas.width;
            downloadCanvas.height = canvas.height;
            const ctx = downloadCanvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, downloadCanvas.width, downloadCanvas.height);
            ctx.drawImage(canvas, 0, 0);
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, downloadCanvas.width / 2, 30);
            const link = document.createElement('a');
            link.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = downloadCanvas.toDataURL('image/png');
            link.click();
            alert(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü "${title}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ`);
        }
    </script>
</body>
</html>
