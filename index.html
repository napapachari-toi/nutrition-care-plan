<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Nutrition Care Plan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .welcome-section {
            text-align: center;
            padding: 60px 20px;
        }

        .welcome-section h2 {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .result-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .result-label {
            font-weight: bold;
            color: #495057;
        }

        .result-value {
            color: #667eea;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .top5-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .top5-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .top5-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .top5-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .top5-rank {
            font-weight: bold;
            color: #667eea;
            margin-right: 10px;
        }

        .top5-name {
            flex: 1;
        }

        .top5-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top5-container {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }

            .btn {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üè• Nutrition Care Plan</h1>
            <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('home')">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            <button class="nav-tab" onclick="showPage('form')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="nav-tab" onclick="showPage('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showPage('table')">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <div class="content">
            <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
            <div id="home" class="page active">
                <div class="welcome-section">
                    <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Nutrition Care Plan</h2>
                    <p style="color: #666; margin-bottom: 30px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                    <button class="btn btn-primary" onclick="showPage('form')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                    <button class="btn btn-success" onclick="loadAllData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>

            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div id="form" class="page">
                <h2 style="margin-bottom: 20px;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                <div id="alertContainer"></div>
                
                <form id="patientForm">
                    <input type="hidden" id="editRowNumber" value="">
                    
                    <div class="form-section">
                        <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• *</label>
                                <input type="date" id="recordDate" required>
                            </div>
                            <div class="form-group">
                                <label>HN *</label>
                                <input type="text" id="hn" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ä‡∏∑‡πà‡∏≠ *</label>
                                <input type="text" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                                <input type="text" id="lastName" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ *</label>
                            <select id="ward" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                                <option value="MED">MED</option>
                                <option value="SURG">SURG</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ü©∫ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ</h3>
                        <div class="form-group">
                            <label>Diagnosis (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å) *</label>
                            <select id="diagnosis" required onchange="toggleOtherDiagnosis()">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å --</option>
                                <option value="Stroke">Stroke (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Parkinson's Disease">Parkinson's Disease</option>
                                <option value="Alzheimer's Disease">Alzheimer's Disease</option>
                                <option value="Epilepsy">Epilepsy (‡πÇ‡∏£‡∏Ñ‡∏•‡∏°‡∏ä‡∏±‡∏Å)</option>
                                <option value="Multiple Sclerosis">Multiple Sclerosis</option>
                                <option value="Brain Tumor">Brain Tumor (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≠‡∏Å‡∏™‡∏°‡∏≠‡∏á)</option>
                                <option value="Meningitis">Meningitis (‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö)</option>
                                <option value="Encephalitis">Encephalitis (‡∏™‡∏°‡∏≠‡∏á‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö)</option>
                                <option value="Migraine">Migraine (‡πÑ‡∏°‡πÄ‡∏Å‡∏£‡∏ô)</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="form-group" id="otherDiagnosisGroup" style="display: none;">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" id="otherDiagnosis">
                        </div>
                        <div class="form-group">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="dm" value="DM">
                                    <label for="dm">DM (‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="dlp" value="DLP">
                                    <label for="dlp">DLP (‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ht" value="HT">
                                    <label for="ht">HT (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="gout" value="GOUT">
                                    <label for="gout">GOUT (‡πÄ‡∏Å‡πä‡∏≤‡∏ó‡πå)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ckd" value="CKD">
                                    <label for="ckd">CKD (‡πÑ‡∏ï‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cad" value="CAD">
                                    <label for="cad">CAD (‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="copd" value="COPD">
                                    <label for="copd">COPD (‡∏õ‡∏≠‡∏î‡∏≠‡∏∏‡∏î‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cirrhosis" value="Cirrhosis">
                                    <label for="cirrhosis">Cirrhosis (‡∏ï‡∏±‡∏ö‡πÅ‡∏Ç‡πá‡∏á)</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                            <input type="text" id="otherChronicDiseases">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô NAF (0-15) *</label>
                                <input type="number" id="nafScore" min="0" max="15" required oninput="calculateResults()">
                            </div>
                            <div class="form-group">
                                <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg) *</label>
                                <input type="number" id="weight" step="0.1" required oninput="calculateResults()">
                            </div>
                            <div class="form-group">
                                <label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm) *</label>
                                <input type="number" id="height" step="0.1" required oninput="calculateResults()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Albumin (g/dL)</label>
                                <input type="number" id="albumin" step="0.1" oninput="calculateResults()">
                            </div>
                            <div class="form-group">
                                <label>Total Protein (g/dL)</label>
                                <input type="number" id="totalProtein" step="0.1" oninput="calculateResults()">
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">üìã ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h4>
                        <div class="result-box">
                            <div class="result-item">
                                <span class="result-label">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á NAF:</span>
                                <span class="result-value" id="nafResult">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">BMI:</span>
                                <span class="result-value" id="bmiResult">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Albumin:</span>
                                <span class="result-value" id="albuminResult">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Total Protein:</span>
                                <span class="result-value" id="totalProteinResult">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üìÖ ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° / Follow up</label>
                                <input type="date" id="followUpDate">
                            </div>
                            <div class="form-group">
                                <label>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</label>
                                <select id="followUpResult">
                                    <option value="">-- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° --</option>
                                    <option value="‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô">‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô</option>
                                    <option value="‡∏Ñ‡∏á‡∏ó‡∏µ‡πà">‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</option>
                                    <option value="‡πÅ‡∏¢‡πà‡∏•‡∏á">‡πÅ‡∏¢‡πà‡∏•‡∏á</option>
                                    <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <textarea id="followUpDetails" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" id="submitBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()" id="cancelBtn" style="display: none;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="page">
                <h2 style="margin-bottom: 20px;">üìä Dashboard - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPatients">-</div>
                        <div class="stat-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="needFollowUp">-</div>
                        <div class="stat-label">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="followedUp">-</div>
                        <div class="stat-label">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                </div>

                <!-- Top 5 Diagnosis ‡πÅ‡∏•‡∏∞ ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß -->
                <div class="top5-container">
                    <div class="top5-card">
                        <h3>üèÜ Top 5 Diagnosis (‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å)</h3>
                        <div id="top5Diagnosis"></div>
                    </div>
                    <div class="top5-card">
                        <h3>üèÜ Top 5 ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</h3>
                        <div id="top5Chronic"></div>
                    </div>
                </div>

                <div id="chartsContainer"></div>
            </div>

            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div id="table" class="page">
                <h2 style="margin-bottom: 20px;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="loadAllData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div id="tableContainer"></div>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <strong id="deletePatientName"></strong> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <p style="color: #dc3545; margin-top: 10px;">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-danger" onclick="confirmDelete()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà URL ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≤‡∏Å Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyT63XP7ugf7QovhgCLtfA3QWLeEr06ibZAlZKZQYtyDuCx1jjvP6xWIH0sQqR4xSps/exec';
        
        let patients = [];
        let deleteRowNumber = null;

        window.onload = function() {
            setDefaultDate();
            loadAllData();
        };

        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');

            if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'table') {
                renderTable();
            }
        }

        function toggleOtherDiagnosis() {
            const diagnosis = document.getElementById('diagnosis').value;
            const otherGroup = document.getElementById('otherDiagnosisGroup');
            otherGroup.style.display = diagnosis === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? 'block' : 'none';
        }

        function calculateResults() {
            const nafScore = parseFloat(document.getElementById('nafScore').value) || 0;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            const albumin = parseFloat(document.getElementById('albumin').value) || 0;
            const totalProtein = parseFloat(document.getElementById('totalProtein').value) || 0;

            let nafResult = '-';
            if (nafScore >= 0 && nafScore <= 15) {
                if (nafScore >= 10) nafResult = '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á (‚â•10)';
                else if (nafScore >= 6) nafResult = '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (6-9)';
                else nafResult = '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ (<6)';
            }

            let bmiResult = '-';
            if (weight > 0 && height > 0) {
                const bmi = weight / Math.pow(height / 100, 2);
                let status = '';
                if (bmi < 18.5) status = '‡∏ú‡∏≠‡∏°';
                else if (bmi < 23) status = '‡∏õ‡∏Å‡∏ï‡∏¥';
                else if (bmi < 25) status = '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô';
                else if (bmi < 30) status = '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 1';
                else status = '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 2';
                bmiResult = `${bmi.toFixed(2)} (${status})`;
            }

            let albuminResult = '-';
            if (albumin > 0) {
                if (albumin >= 3.5) albuminResult = `${albumin} (‡∏õ‡∏Å‡∏ï‡∏¥)`;
                else if (albumin >= 3.0) albuminResult = `${albumin} (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)`;
                else albuminResult = `${albumin} (‡∏ï‡πà‡∏≥)`;
            }

            let totalProteinResult = '-';
            if (totalProtein > 0) {
                if (totalProtein >= 6.0 && totalProtein <= 8.3) totalProteinResult = `${totalProtein} (‡∏õ‡∏Å‡∏ï‡∏¥)`;
                else if (totalProtein < 6.0) totalProteinResult = `${totalProtein} (‡∏ï‡πà‡∏≥)`;
                else totalProteinResult = `${totalProtein} (‡∏™‡∏π‡∏á)`;
            }

            document.getElementById('nafResult').textContent = nafResult;
            document.getElementById('bmiResult').textContent = bmiResult;
            document.getElementById('albuminResult').textContent = albuminResult;
            document.getElementById('totalProteinResult').textContent = totalProteinResult;
        }

        function getChronicDiseases() {
            const diseases = [];
            const checkboxes = ['dm', 'dlp', 'ht', 'gout', 'ckd', 'cad', 'copd', 'cirrhosis'];
            checkboxes.forEach(id => {
                if (document.getElementById(id).checked) {
                    diseases.push(document.getElementById(id).value);
                }
            });
            const other = document.getElementById('otherChronicDiseases').value.trim();
            if (other) diseases.push(other);
            return diseases;
        }

        function setChronicDiseases(diseases) {
            const checkboxes = ['dm', 'dlp', 'ht', 'gout', 'ckd', 'cad', 'copd', 'cirrhosis'];
            checkboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
            document.getElementById('otherChronicDiseases').value = '';
            
            if (!diseases) return;
            
            const diseaseArray = Array.isArray(diseases) ? diseases : diseases.split(',').map(d => d.trim());
            const standardDiseases = ['DM', 'DLP', 'HT', 'GOUT', 'CKD', 'CAD', 'COPD', 'Cirrhosis'];
            const otherDiseases = [];
            
            diseaseArray.forEach(disease => {
                const checkbox = checkboxes.find(id => document.getElementById(id).value === disease);
                if (checkbox) {
                    document.getElementById(checkbox).checked = true;
                } else if (disease && !standardDiseases.includes(disease)) {
                    otherDiseases.push(disease);
                }
            });
            
            if (otherDiseases.length > 0) {
                document.getElementById('otherChronicDiseases').value = otherDiseases.join(', ');
            }
        }

        async function loadAllData() {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (data.status === 'success') {
                    patients = data.data;
                    renderTable();
                    updateDashboard();
                    showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
                } else {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            } finally {
                showLoading(false);
            }
        }

        document.getElementById('patientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const diagnosis = document.getElementById('diagnosis').value;
            const finalDiagnosis = diagnosis === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? document.getElementById('otherDiagnosis').value : diagnosis;
            const chronicDiseases = getChronicDiseases().join(', ');

            const formData = {
                action: document.getElementById('editRowNumber').value ? 'update' : 'add',
                rowNumber: document.getElementById('editRowNumber').value || '',
                recordDate: document.getElementById('recordDate').value,
                hn: document.getElementById('hn').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                ward: document.getElementById('ward').value,
                diagnosis: finalDiagnosis,
                chronicDiseases: chronicDiseases,
                nafScore: document.getElementById('nafScore').value,
                weight: document.getElementById('weight').value,
                height: document.getElementById('height').value,
                albumin: document.getElementById('albumin').value || '',
                totalProtein: document.getElementById('totalProtein').value || '',
                followUpDate: document.getElementById('followUpDate').value || '',
                followUpResult: document.getElementById('followUpResult').value || '',
                followUpDetails: document.getElementById('followUpDetails').value || ''
            };

            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const isEdit = formData.action === 'update';
                    showAlert(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
                    resetForm();
                    await loadAllData();
                    setTimeout(() => showPage('table'), 1500);
                } else {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'), 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            } finally {
                showLoading(false);
            }
        });

        function resetForm() {
            document.getElementById('patientForm').reset();
            document.getElementById('editRowNumber').value = '';
            document.getElementById('otherDiagnosisGroup').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('cancelBtn').style.display = 'none';
            calculateResults();
            setDefaultDate();
        }

        function editPatient(rowNumber) {
            const patient = patients.find(p => p.rowNumber == rowNumber);
            if (!patient) return;

            document.getElementById('editRowNumber').value = patient.rowNumber;
            document.getElementById('recordDate').value = patient.recordDate || '';
            document.getElementById('hn').value = patient.hn || '';
            document.getElementById('firstName').value = patient.firstName || '';
            document.getElementById('lastName').value = patient.lastName || '';
            document.getElementById('ward').value = patient.ward || '';
            
            const standardDiagnoses = ['Stroke', "Parkinson's Disease", "Alzheimer's Disease", 'Epilepsy', 
                                       'Multiple Sclerosis', 'Brain Tumor', 'Meningitis', 'Encephalitis', 'Migraine'];
            
            if (standardDiagnoses.includes(patient.diagnosis)) {
                document.getElementById('diagnosis').value = patient.diagnosis;
            } else {
                document.getElementById('diagnosis').value = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                document.getElementById('otherDiagnosis').value = patient.diagnosis;
                toggleOtherDiagnosis();
            }

            setChronicDiseases(patient.chronicDiseases);
            document.getElementById('nafScore').value = patient.nafScore || '';
            document.getElementById('weight').value = patient.weight || '';
            document.getElementById('height').value = patient.height || '';
            document.getElementById('albumin').value = patient.albumin || '';
            document.getElementById('totalProtein').value = patient.totalProtein || '';
            document.getElementById('followUpDate').value = patient.followUpDate || '';
            document.getElementById('followUpResult').value = patient.followUpResult || '';
            document.getElementById('followUpDetails').value = patient.followUpDetails || '';

            calculateResults();
            
            document.getElementById('submitBtn').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            showPage('form');
        }

        function deletePatient(rowNumber) {
            const patient = patients.find(p => p.rowNumber == rowNumber);
            if (!patient) return;

            deleteRowNumber = rowNumber;
            document.getElementById('deletePatientName').textContent = 
                `${patient.firstName} ${patient.lastName} (HN: ${patient.hn})`;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteRowNumber = null;
        }

        async function confirmDelete() {
            if (!deleteRowNumber) return;

            showLoading(true);
            closeDeleteModal();

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'delete',
                        rowNumber: deleteRowNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üóëÔ∏è', 'success');
                    await loadAllData();
                } else {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'danger');
            } finally {
                showLoading(false);
            }
        }

        function renderTable() {
            const container = document.getElementById('tableContainer');
            if (patients.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>';
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th>HN</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                            <th>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å</th>
                            <th>NAF</th>
                            <th>BMI</th>
                            <th>Albumin</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            patients.forEach(patient => {
                const bmi = patient.weight && patient.height ? 
                    (patient.weight / Math.pow(patient.height / 100, 2)).toFixed(2) : '-';
                const fullName = `${patient.firstName || ''} ${patient.lastName || ''}`.trim();
                const followUpStatus = patient.followUpResult || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
                const recordDate = patient.recordDate ? new Date(patient.recordDate).toLocaleDateString('th-TH') : '-';
                
                html += `
                    <tr>
                        <td>${recordDate}</td>
                        <td>${patient.hn || '-'}</td>
                        <td>${fullName}</td>
                        <td>${patient.ward || '-'}</td>
                        <td>${patient.diagnosis || '-'}</td>
                        <td>${patient.nafScore || '-'}</td>
                        <td>${bmi}</td>
                        <td>${patient.albumin || '-'}</td>
                        <td>${followUpStatus}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-warning" onclick="editPatient(${patient.rowNumber})" style="padding: 5px 10px; margin: 2px;">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deletePatient(${patient.rowNumber})" style="padding: 5px 10px; margin: 2px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function updateDashboard() {
            const total = patients.length;
            const needFollowUp = patients.filter(p => 
                !p.followUpDate || p.followUpResult === '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á'
            ).length;
            const followedUp = patients.filter(p => 
                p.followUpDate && p.followUpResult && p.followUpResult !== '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á'
            ).length;

            document.getElementById('totalPatients').textContent = total;
            document.getElementById('needFollowUp').textContent = needFollowUp;
            document.getElementById('followedUp').textContent = followedUp;

            renderTop5Diagnosis();
            renderTop5Chronic();
            renderCharts();
        }

        function renderTop5Diagnosis() {
            const diagnosisCounts = {};
            patients.forEach(p => {
                if (p.diagnosis) {
                    diagnosisCounts[p.diagnosis] = (diagnosisCounts[p.diagnosis] || 0) + 1;
                }
            });

            const sorted = Object.entries(diagnosisCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('top5Diagnosis');
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            let html = '';
            sorted.forEach(([diagnosis, count], index) => {
                html += `
                    <div class="top5-item">
                        <span class="top5-rank">#${index + 1}</span>
                        <span class="top5-name">${diagnosis}</span>
                        <span class="top5-count">${count}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderTop5Chronic() {
            const chronicCounts = {};
            patients.forEach(p => {
                if (p.chronicDiseases) {
                    const diseases = p.chronicDiseases.split(',').map(d => d.trim()).filter(d => d);
                    diseases.forEach(disease => {
                        chronicCounts[disease] = (chronicCounts[disease] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(chronicCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('top5Chronic');
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            let html = '';
            sorted.forEach(([disease, count], index) => {
                html += `
                    <div class="top5-item">
                        <span class="top5-rank">#${index + 1}</span>
                        <span class="top5-name">${disease}</span>
                        <span class="top5-count">${count}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderCharts() {
            const container = document.getElementById('chartsContainer');
            
            const nafGroups = { '‡∏ï‡πà‡∏≥ (<6)': 0, '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (6-9)': 0, '‡∏™‡∏π‡∏á (‚â•10)': 0 };
            patients.forEach(p => {
                const score = parseFloat(p.nafScore);
                if (score >= 10) nafGroups['‡∏™‡∏π‡∏á (‚â•10)']++;
                else if (score >= 6) nafGroups['‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (6-9)']++;
                else if (score >= 0) nafGroups['‡∏ï‡πà‡∏≥ (<6)']++;
            });

            const wardGroups = {};
            patients.forEach(p => {
                if (p.ward) {
                    wardGroups[p.ward] = (wardGroups[p.ward] || 0) + 1;
                }
            });

            const bmiGroups = { '‡∏ú‡∏≠‡∏°': 0, '‡∏õ‡∏Å‡∏ï‡∏¥': 0, '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô': 0, '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô': 0 };
            patients.forEach(p => {
                if (p.weight && p.height) {
                    const bmi = p.weight / Math.pow(p.height / 100, 2);
                    if (bmi < 18.5) bmiGroups['‡∏ú‡∏≠‡∏°']++;
                    else if (bmi < 23) bmiGroups['‡∏õ‡∏Å‡∏ï‡∏¥']++;
                    else if (bmi < 25) bmiGroups['‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô']++;
                    else bmiGroups['‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô']++;
                }
            });

            const albuminGroups = { '‡∏õ‡∏Å‡∏ï‡∏¥ (‚â•3.5)': 0, '‡∏ï‡πà‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (3.0-3.4)': 0, '‡∏ï‡πà‡∏≥ (<3.0)': 0, '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': 0 };
            patients.forEach(p => {
                const alb = parseFloat(p.albumin);
                if (!alb) albuminGroups['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']++;
                else if (alb >= 3.5) albuminGroups['‡∏õ‡∏Å‡∏ï‡∏¥ (‚â•3.5)']++;
                else if (alb >= 3.0) albuminGroups['‡∏ï‡πà‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (3.0-3.4)']++;
                else albuminGroups['‡∏ï‡πà‡∏≥ (<3.0)']++;
            });

            const proteinGroups = { '‡∏õ‡∏Å‡∏ï‡∏¥ (6.0-8.3)': 0, '‡∏ï‡πà‡∏≥ (<6.0)': 0, '‡∏™‡∏π‡∏á (>8.3)': 0, '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': 0 };
            patients.forEach(p => {
                const tp = parseFloat(p.totalProtein);
                if (!tp) proteinGroups['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']++;
                else if (tp >= 6.0 && tp <= 8.3) proteinGroups['‡∏õ‡∏Å‡∏ï‡∏¥ (6.0-8.3)']++;
                else if (tp < 6.0) proteinGroups['‡∏ï‡πà‡∏≥ (<6.0)']++;
                else proteinGroups['‡∏™‡∏π‡∏á (>8.3)']++;
            });

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    <div class="chart-container">
                        <h3>‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (NAF Score)</h3>
                        ${renderPieChart(nafGroups, ['#FF6384', '#FFCE56', '#36A2EB'])}
                    </div>
                    <div class="chart-container">
                        <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏≠</h3>
                        ${renderPieChart(wardGroups, ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'])}
                    </div>
                    <div class="chart-container">
                        <h3>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤ BMI</h3>
                        ${renderPieChart(bmiGroups, ['#4facfe', '#00f2fe', '#feca57', '#ee5a6f'])}
                    </div>
                    <div class="chart-container">
                        <h3>‡∏Ñ‡πà‡∏≤ Albumin</h3>
                        ${renderPieChart(albuminGroups, ['#43e97b', '#FFCE56', '#FF6384', '#cccccc'])}
                    </div>
                    <div class="chart-container">
                        <h3>‡∏Ñ‡πà‡∏≤ Total Protein</h3>
                        ${renderPieChart(proteinGroups, ['#00f2fe', '#4facfe', '#f093fb', '#cccccc'])}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function renderPieChart(data, colors) {
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            
            if (total === 0) {
                return '<p style="text-align: center; color: #666; padding: 40px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }

            const entries = Object.entries(data).filter(([_, value]) => value > 0);
            
            let currentAngle = -90; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            let segments = [];
            
            entries.forEach(([label, value], index) => {
                const percentage = (value / total) * 100;
                const angle = (value / total) * 360;
                const endAngle = currentAngle + angle;
                
                const color = colors[index % colors.length];
                
                segments.push({
                    label,
                    value,
                    percentage: percentage.toFixed(1),
                    startAngle: currentAngle,
                    endAngle: endAngle,
                    color
                });
                
                currentAngle = endAngle;
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á SVG Pie Chart
            let svgPaths = '';
            segments.forEach(segment => {
                const largeArc = (segment.endAngle - segment.startAngle) > 180 ? 1 : 0;
                
                const startRad = (segment.startAngle * Math.PI) / 180;
                const endRad = (segment.endAngle * Math.PI) / 180;
                
                const x1 = 100 + 80 * Math.cos(startRad);
                const y1 = 100 + 80 * Math.sin(startRad);
                const x2 = 100 + 80 * Math.cos(endRad);
                const y2 = 100 + 80 * Math.sin(endRad);
                
                svgPaths += `
                    <path d="M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z"
                          fill="${segment.color}"
                          stroke="white"
                          stroke-width="2"
                          opacity="0.9"
                          style="transition: opacity 0.3s;"
                          onmouseover="this.style.opacity='1'"
                          onmouseout="this.style.opacity='0.9'">
                        <title>${segment.label}: ${segment.value} (${segment.percentage}%)</title>
                    </path>
                `;
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Legend
            let legend = '<div style="margin-top: 20px;">';
            segments.forEach(segment => {
                legend += `
                    <div style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                        <div style="width: 20px; height: 20px; background: ${segment.color}; border-radius: 3px; margin-right: 10px; flex-shrink: 0;"></div>
                        <div style="flex: 1;">
                            <strong>${segment.label}</strong>
                        </div>
                        <div style="margin-left: 10px; color: #667eea; font-weight: bold;">
                            ${segment.value} (${segment.percentage}%)
                        </div>
                    </div>
                `;
            });
            legend += '</div>';

            return `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <svg viewBox="0 0 200 200" style="max-width: 250px; height: auto; margin: 0 auto;">
                        ${svgPaths}
                    </svg>
                    ${legend}
                </div>
            `;
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 
                               type === 'warning' ? 'alert-warning' : 
                               type === 'info' ? 'alert-info' : 'alert-danger';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
